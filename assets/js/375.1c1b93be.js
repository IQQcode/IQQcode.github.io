(window.webpackJsonp=window.webpackJsonp||[]).push([[375],{698:function(s,t,_){"use strict";_.r(t);var v=_(3),a=Object(v.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"【锁的实现】"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#【锁的实现】"}},[s._v("#")]),s._v(" 【锁的实现】")]),s._v(" "),t("p",[s._v("InnoDB行锁：只有通过索引条件检索数据，InnoDB才会使用行级锁，否则，InnoDB将使用表锁！")]),s._v(" "),t("p",[t("strong",[s._v("InnoDB-行锁是基于索引来实现的：")])]),s._v(" "),t("ul",[t("li",[t("p",[t("strong",[s._v("行锁必须有索引才能实现，否则会自动锁全表")])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("两个事务不能锁同一个索引")])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("类型转换导致行锁升级为表锁")]),s._v("。在MySql的写语句中，给表列赋值与表类型不符合时，MySql底层的优化器发挥作用，会做一个强制类型转化，此时能正常操作，但会导致行锁升级为表锁")])])]),s._v(" "),t("br"),s._v(" "),t("h2",{attrs:{id:"_1-mysql锁分类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-mysql锁分类"}},[s._v("#")]),s._v(" 1. Mysql锁分类")]),s._v(" "),t("p",[t("strong",[s._v("锁概述")]),s._v("锁是计算机协调多个进程或线程并发访问某一资源的机制（避免资源争抢）。")]),s._v(" "),t("p",[s._v("**从对数据操作的粒度分 ： **")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("表锁：操作时，会锁定整个表")])]),s._v(" "),t("li",[t("p",[s._v("行锁：操作时，会锁定当前操作行")])])]),s._v(" "),t("p",[t("strong",[s._v("从对数据操作的类型分：")])]),s._v(" "),t("ul",[t("li",[s._v("读锁（共享锁）：读锁会阻塞写，但是不会阻塞读")]),s._v(" "),t("li",[s._v("写锁（排它锁）：不能与其他锁并存。当前操作没有完成之前，它会阻断其他写锁和读锁")])]),s._v(" "),t("hr"),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("lock table user "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   -- 加读锁\n\nlock table user "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  -- 加写锁\n\nunlock tables"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          -- 释放锁\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210626232803.png",alt:"image-20201008111141771"}})]),s._v(" "),t("p",[t("strong",[s._v("读锁：")]),s._v(" "),t("code",[s._v("session1")]),s._v(" 对 "),t("strong",[s._v("TableA")]),s._v(" 加读锁")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("session1")]),t("font",{attrs:{color:"red"}},[t("strong",[s._v("可以读")])]),s._v("自己加锁的 "),t("strong",[s._v("TableA")]),s._v("，"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("不能改")])]),s._v("自己的"),t("strong",[s._v("TableA")]),s._v("，"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("不可以读")])]),s._v("其他表")],1),s._v(" "),t("li",[t("code",[s._v("session2")]),s._v(" "),t("font",{attrs:{color:"blue"}},[t("strong",[s._v("可以读")])]),t("strong",[s._v("TableA")]),s._v("，改"),t("strong",[s._v("TableA")]),s._v("时"),t("font",{attrs:{color:"blue"}},[t("strong",[s._v("会阻塞等待，持有者释放锁之后才能改")])]),s._v(" ，可以读其他表")],1)]),s._v(" "),t("p",[t("strong",[s._v("写锁：")]),s._v(" "),t("code",[s._v("session1")]),s._v(" 对 "),t("strong",[s._v("TableA")]),s._v(" 加写锁")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("session1")]),t("font",{attrs:{color:"red"}},[t("strong",[s._v("可以读")])]),s._v("自己加锁的 "),t("strong",[s._v("TableA")]),s._v("，"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("可以改")])]),s._v("自己的"),t("strong",[s._v("TableA")]),s._v("，"),t("font",{attrs:{color:"red"}},[t("strong",[s._v("不可以读")])]),s._v("其他表")],1),s._v(" "),t("li",[t("code",[s._v("session2")]),s._v(" "),t("font",{attrs:{color:"blue"}},[t("strong",[s._v("读")])]),s._v("TableA时会"),t("strong",[s._v("阻塞等待")]),s._v("，持有者释放锁之后才能可以读。"),t("strong",[s._v("不可以改")]),s._v("TableA，可以读其他表")],1)]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("各存储引擎对锁的支持情况：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("存储引擎")]),s._v(" "),t("th",[s._v("表级锁")]),s._v(" "),t("th",[s._v("行级锁")]),s._v(" "),t("th",[s._v("页面锁")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("MyISAM")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("不支持")]),s._v(" "),t("td",[s._v("不支持")])]),s._v(" "),t("tr",[t("td",[s._v("InnoDB")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("不支持")])])])]),s._v(" "),t("p",[s._v("MySQL这3种锁的特性可大致归纳如下 ：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210626232809.png",alt:"image-20200824163558057"}})]),s._v(" "),t("p",[s._v("从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适！")]),s._v(" "),t("p",[s._v("仅从锁的角度来说：表级锁更适合于以"),t("strong",[s._v("查询为主，只有少量按索引条件更新数据的应用")]),s._v("，如Web 应用；")]),s._v(" "),t("p",[t("strong",[s._v("行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并查询的应用")]),s._v("，如一些在线事务处理（OLTP）系统。")]),s._v(" "),t("h2",{attrs:{id:"_2-myisam-表锁-偏读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-myisam-表锁-偏读"}},[s._v("#")]),s._v(" 2. MyISAM 表锁-偏读")]),s._v(" "),t("p",[s._v("MyISAM 存储引擎只支持"),t("strong",[s._v("表锁")]),s._v("，这也是MySQL开始几个版本中唯一支持的锁类型。")]),s._v(" "),t("h3",{attrs:{id:"如何加表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何加表锁"}},[s._v("#")]),s._v(" 如何加表锁")]),s._v(" "),t("p",[t("strong",[s._v("加锁的过程是自动的")]),s._v("。MyISAM 在执行查询语句（SELECT）前，会"),t("strong",[s._v("自动给涉及的所有表加读锁")]),s._v("，在执行更新操作（UPDATE、DELETE、INSERT 等）前，会"),t("strong",[s._v("自动给涉及的表加写锁")]),s._v("，这个过程并不需要用户干预，因此，用户一般不需要直接用 "),t("code",[s._v("LOCK TABLE")]),s._v(" 命令给 MyISAM 表显式加锁。")]),s._v(" "),t("p",[s._v("显示加表锁语法：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("加读锁 ： lock table table_name "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n加写锁 ： lock table table_name write；\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("锁模式的相互兼容性如表中所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210626232815.png",alt:"1553905621992"}})]),s._v(" "),t("p",[s._v("由上表可见：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("简而言之，就是读锁会阻塞写，但是不会阻塞读。")])]),s._v(" "),t("li",[t("p",[s._v("而写锁，则既会阻塞读，又会阻塞写。")])])]),s._v(" "),t("p",[s._v("此外，MyISAM 的读写锁调度是"),t("strong",[s._v("写优先")]),s._v("，这也是"),t("strong",[s._v("MyISAM不适合做写为主的表")]),s._v("的存储引擎的原因。因为写锁后，"),t("em",[s._v("其他线程不能做任何操作")]),s._v("，大量的更新会使查询很难得到锁，从而造成永远阻塞。")]),s._v(" "),t("br"),s._v(" "),t("h2",{attrs:{id:"_3-innodb-行锁-偏写"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-innodb-行锁-偏写"}},[s._v("#")]),s._v(" 3. InnoDB 行锁-偏写")]),s._v(" "),t("h3",{attrs:{id:"行锁介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#行锁介绍"}},[s._v("#")]),s._v(" 行锁介绍")]),s._v(" "),t("p",[t("strong",[s._v("行锁特点 ：")])]),s._v(" "),t("ul",[t("li",[s._v("偏向InnoDB 存储引擎，开销大，加锁慢；")]),s._v(" "),t("li",[s._v("会出现死锁；")]),s._v(" "),t("li",[s._v("锁定粒度最小，发生锁冲突的概率最低，并发度也最高。")])]),s._v(" "),t("p",[s._v("InnoDB 与 MyISAM 的最大不同有两点："),t("strong",[s._v("一是支持事务；二是采用了行锁")])]),s._v(" "),t("br"),s._v(" "),t("h3",{attrs:{id:"innodb-的行锁模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb-的行锁模式"}},[s._v("#")]),s._v(" InnoDB 的行锁模式")]),s._v(" "),t("p",[t("strong",[s._v("InnoDB 支持行锁和表锁")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("对于"),t("code",[s._v("UPDATE")]),s._v("、"),t("code",[s._v("DELETE")]),s._v("和"),t("code",[s._v("INSERT")]),s._v("语句，InnoDB会自动给涉及数据集加排他锁（X)；")])]),s._v(" "),t("li",[t("p",[s._v("对于普通"),t("code",[s._v("SELECT")]),s._v("语句，InnoDB不会加任何锁；")])])]),s._v(" "),t("p",[s._v("可以通过以下语句显示给记录集加共享锁或排他锁")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("共享锁"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": SELECT * FROM table_name WHERE "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". LOCK IN SHARE MODE\n\n排他锁"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("X"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": SELECT * FROM table_name WHERE "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". FOR UPDATE\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"_4-索引行锁升级为表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-索引行锁升级为表锁"}},[s._v("#")]),s._v(" 4. 索引行锁升级为表锁")]),s._v(" "),t("p",[t("strong",[s._v("如果不通过索引条件检索数据")]),s._v("，那么InnoDB将对表中的所有记录加锁，实际效果跟表锁一样。")]),s._v(" "),t("p",[s._v("**索引失效，最终行锁变为表锁 **")]),s._v(" "),t("p",[s._v("为何索引会失效？——— 使用的索引字段的数据类型 与 定义的数据类型不符。")]),s._v(" "),t("p",[s._v("查看当前表的索引 ：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("show  index  from test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("由于执行更新时 ， name字段本来为"),t("code",[s._v("varchar")]),s._v("类型， 我们是作为"),t("code",[s._v("int")]),s._v("类型使用，存在类型转换的异常，所以索引失效，行锁变为表锁")]),s._v(" "),t("h3",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[t("strong",[s._v("优化建议：")])]),s._v(" "),t("ul",[t("li",[s._v("避免无索引行锁升级为表锁，尽可能让所有数据检索都能通过索引来完成")]),s._v(" "),t("li",[s._v("合理设计索引，尽量缩小锁的范围")]),s._v(" "),t("li",[s._v("尽可能减少索引条件，及索引范围，避免间隙锁")]),s._v(" "),t("li",[s._v("尽量控制事务大小，减少锁定资源量和时间长度")])])])}),[],!1,null,null,null);t.default=a.exports}}]);