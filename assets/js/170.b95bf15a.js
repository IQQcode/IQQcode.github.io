(window.webpackJsonp=window.webpackJsonp||[]).push([[170],{495:function(s,t,a){"use strict";a.r(t);var n=a(3),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("sychronized的使用场景：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212910.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("h2",{attrs:{id:"_1-synchronized的特点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-synchronized的特点"}},[s._v("#")]),s._v(" 1. synchronized的特点")]),s._v(" "),t("ol",[t("li",[s._v("有序性：禁止指令重排")]),s._v(" "),t("li",[s._v("可见性：JMM内存模型")]),s._v(" "),t("li",[s._v("原子性：加锁")]),s._v(" "),t("li",[t("strong",[s._v("可重入性")]),s._v("：synchronized锁计数器")]),s._v(" "),t("li",[t("strong",[s._v("不可中断性")]),s._v("：锁不可被中断（区别于Lock的tryLock）")]),s._v(" "),t("li",[t("strong",[s._v("非公平")]),s._v("：Lock可实现公平")])]),s._v(" "),t("br"),s._v(" "),t("h2",{attrs:{id:"_2-对象锁monitor机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-对象锁monitor机制"}},[s._v("#")]),s._v(" 2. 对象锁monitor机制")]),s._v(" "),t("h3",{attrs:{id:"对象在内存中的存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#对象在内存中的存储"}},[s._v("#")]),s._v(" 对象在内存中的存储")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212917.png",alt:"image-20201029091926286"}})]),s._v(" "),t("p",[t("strong",[s._v("【对象头】")]),s._v(" 对象为8byte")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("Mark Word（标记字段）")]),s._v("：默认存储对象的"),t("code",[s._v("HashCode")]),s._v("，分代年龄和锁标志位信息。他会根据对象的状态-复用自己的存储空间，Mark Word中的数据会随着标志位的变化而变化")]),s._v(" "),t("li",[t("strong",[s._v("Klass Point（类型指针）")]),s._v("：对象指向它类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例")])]),s._v(" "),t("p",[t("strong",[s._v("【实例数据】")]),s._v("：存放类的数据信息，父类的信息")]),s._v(" "),t("p",[t("strong",[s._v("【对齐填充数据】")]),s._v("：虚拟机要求对象起始地址必须是8字节的整数倍")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212923.png",alt:"image-20200820161201862"}})]),s._v(" "),t("ul",[t("li",[t("p",[s._v("刚开始"),t("strong",[s._v("Monitor")]),s._v("中Owner为null")])]),s._v(" "),t("li",[t("p",[s._v("当Thread-2执行"),t("code",[s._v("synchronized(obj)")]),s._v("就会成为"),t("strong",[s._v("Monitor")]),s._v("的所有者，"),t("strong",[s._v("Owner")]),s._v("置为Thread-2，Monitor中只能有一个Owner")])]),s._v(" "),t("li",[t("p",[s._v("在Thread-2上锁的过程中，如果Thread-3、Thread-4、Thread-5也来执行"),t("code",[s._v("synchronized(obj)")]),s._v("，就会进入"),t("strong",[s._v("EntryList BLOCKED")])])]),s._v(" "),t("li",[t("p",[s._v("Thread-2执行完同步代码块的内容，然后唤醒EntryList中等待的线程来竞争锁；"),t("strong",[s._v("竞争的时是非公平的")]),s._v("，并不是先进入EntryList中得线程先获取锁，取决于操作系统调度器的调度顺序")])]),s._v(" "),t("li",[t("p",[s._v("图中WaitSet中的Thread-0、Thread-1是"),t("strong",[s._v("已经获得锁")]),s._v("，但"),t("strong",[s._v("条件不满足")]),s._v("进入WAITING状态的线程")])])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("注意")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("synchronized必须是进入"),t("strong",[s._v("同一个对象")]),s._v("的monitor才有上述的效果")])]),s._v(" "),t("li",[t("p",[s._v("不加synchronized的对象不会关联监视器，不遵从以上规则")])])])]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"_3-synchronized底层原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-synchronized底层原理"}},[s._v("#")]),s._v(" 3. synchronized底层原理")]),s._v(" "),t("h3",{attrs:{id:"synchronized修饰同步代码块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#synchronized修饰同步代码块"}},[s._v("#")]),s._v(" synchronized修饰同步代码块")]),s._v(" "),t("p",[s._v("先来看一段简单的代码\n"),t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212937.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("为了解到synchronized的底层实现原理，我们来对这段代码进行反编译")]),s._v(" "),t("p",[s._v("先通过"),t("code",[s._v("cd")]),s._v("命令进入到src下的package目录")]),s._v(" "),t("p",[s._v("先编译"),t("code",[s._v("javac Test.java")]),s._v("，生成class文件")]),s._v(" "),t("p",[s._v("反编译命令：")]),s._v(" "),t("p",[t("code",[s._v("javap -c -v Test.class")])]),s._v(" "),t("p",[s._v("然后我们来看"),t("strong",[s._v("同步代码块")]),s._v("下生成的字节码：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212943.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    descriptor"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Ljava")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),s._v("\n    flags"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ACC_PUBLIC")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ACC_STATIC")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Code")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      stack"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" locals"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args_size"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" getstatic     #"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// <- lock引用<synchronized开始>          ")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" dup\n         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" astore_1             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lock引用，存入局部变量表slot_1")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" monitorenter         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将lock对象 Markward置为 Monitor指针")]),s._v("\n         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" getstatic     #"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("                  \n         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" ldc           #"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("                  \n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" invokevirtual #"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("                 \n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" aload_1\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" monitorexit          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将lock对象MarkWard重置，唤醒EntryList ")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("goto")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" astore_2\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" aload_1\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" monitorexit          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将lock对象 Markward重置，唤醒 EntryList")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" aload_2\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" athrow\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" table"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 异常监测表")]),s._v("\n         from    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("target")]),s._v(" type   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 监测范围")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("   any\n            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("   any\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("p",[s._v("执行同步代码块后首先要先执行"),t("code",[s._v("monitorenter")]),s._v("指令，退出的时候执行"),t("code",[s._v("monitorexit")]),s._v("指令。")]),s._v(" "),t("p",[s._v("通过分析之后可以看出，使用"),t("strong",[s._v("synchronized")]),s._v("进行同步，其关键就是要获取对象的监视器"),t("code",[s._v("monitor")]),s._v("，当线程获取"),t("code",[s._v("monitor")]),s._v("后才能继续往下执行，否则就只能等待。")]),s._v(" "),t("p",[s._v("而这个获取的过程是互斥的，即同一时刻只有一个线程能够获取到"),t("code",[s._v("monitor")]),s._v("。")]),s._v(" "),t("p",[s._v("上述字节码中包含一个"),t("code",[s._v("monitorenter")]),s._v("指令以及两个"),t("code",[s._v("monitorexit")]),s._v("指令。这是因为JVM需要确保获得的锁在正常执行路径、异常执行路径上都能够被解锁。")]),s._v(" "),t("h3",{attrs:{id:"synchronized修饰同步方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#synchronized修饰同步方法"}},[s._v("#")]),s._v(" synchronized修饰同步方法")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212949.png",alt:"在这里插入图片描述"}}),s._v("\n当用"),t("strong",[s._v("synchronized")]),s._v("标记方法时，字节码中方法的访问标记"),t("code",[s._v("flags")]),s._v("多了 "),t("code",[s._v("ACC_SYNCHRONIZED")]),s._v("。")]),s._v(" "),t("ul",[t("li",[s._v("进入该方法时，JVM需要进行 "),t("code",[s._v("monitorenter")]),s._v(" 操作")]),s._v(" "),t("li",[s._v("退出该方法时，不管是正常返回，还是向调用者抛异常，JVM均需要进行 "),t("code",[s._v("monitorexit")]),s._v(" 操作")])]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"monitorenter-monitorexit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#monitorenter-monitorexit"}},[s._v("#")]),s._v(" monitorenter---monitorexit")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("关于monitorenter 和 monitorexit 的作用，我们可以抽象地理解为：每个锁对象拥有一个锁计数器和一个 “指向持有该锁的线程” 的指针（对象头）")])]),s._v(" "),t("li",[t("p",[s._v("当执行monitorenter时，如果目标锁对象的计数器为0，那么说明它没有被其他线程所持有。在这个情况下JVM会将该锁对象的持有线程设置为当前线程，并且将其计数器加1")])]),s._v(" "),t("li",[t("p",[s._v("在目标锁对象的计数器不为0的情况下，如果锁对象的持有线程是当前线程，那么JVM可以将其计数器再加1；否则需要等待，直至持有线程释放该锁")])]),s._v(" "),t("li",[t("p",[s._v("当执行monitorexit时，JVM则需将锁对象的计数器减1。当计数器减为0时，便代表该锁已经被释放掉了")])])]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"可重入锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#可重入锁"}},[s._v("#")]),s._v(" 可重入锁")]),s._v(" "),t("p",[s._v("当执行"),t("code",[s._v("monitorenter")]),s._v("时，对象的"),t("strong",[s._v("monitor计数器")]),s._v("值不为0，但是持有锁的线程恰好是当前线程。此时将monitor计数器值再次"),t("code",[s._v("+1")]),s._v("，当前线程再次进入同步方法或代码块")]),s._v(" "),t("p",[s._v("之所以采用这种计数器的方式，是为了"),t("strong",[s._v("允许同一个线程重复获取同一把锁")])]),s._v(" "),t("p",[s._v("【证明锁的可重入与互斥】")]),s._v(" "),t("p",[s._v("synchronized修饰的"),t("code",[s._v("test1")]),s._v("方法中调用"),t("code",[s._v("test2")]),s._v("方法")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Sync")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("equals")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"A"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("equals")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"B"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"B线程进入该同步方法test2()..."')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//此时B线程还没有启动")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程---\x3e进入test2()方法"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Reentrant")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Sync")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Sync")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"A"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//有时间差，保证A先启动")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"B"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617212958.gif",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[s._v("如果一个类中拥有多个synchronized方法，那么这些方法之间的相互调用，不管是直接的还是间接的，都会涉及对同一把锁的重复加锁操作")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"_4-jdk1-6后对synchronized的优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-jdk1-6后对synchronized的优化"}},[s._v("#")]),s._v(" 4. JDK1.6后对synchronized的优化")]),s._v(" "),t("p",[s._v("synchronized的操作都是互斥的，Monitor机制是由操作系统来提供的，效率低。")]),s._v(" "),t("p",[s._v("当一个线程拿到了锁资源之后，因为要保证同步，所以其他线程只能等待该线程释放锁，效率自然降低。")]),s._v(" "),t("p",[t("strong",[s._v("优化的思想：让每个线程通过同步代码块时的速度提高")])]),s._v(" "),t("h3",{attrs:{id:"锁升级的过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁升级的过程"}},[s._v("#")]),s._v(" 锁升级的过程")]),s._v(" "),t("p",[s._v("面：synchronized是个重量级锁，那它的优化有了解嘛？")]),s._v(" "),t("p",[s._v("应：为了减少获得锁和和释放锁带来的性能损耗引入了偏向锁、轻量级锁、重量级锁来进行优化，锁升级的过程如下：")]),s._v(" "),t("p",[t("strong",[s._v("无锁 -> 偏向锁 -> 轻量级锁 -> 重量级锁")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617213005.png",alt:"image-20201029093856354"}})]),s._v(" "),t("p",[s._v("首先是一个"),t("strong",[s._v("无锁")]),s._v("的状态，当线程进入同步代码块的时候，会检查对象头内和栈帧中的锁记录-是否是-存入当前线程的ID。如果没有，则使用**CAS **进行替换。对象头是由Mark Word和Klass pointer 组成，锁争夺也就是对象头指向的Monitor对象的争夺，一旦有线程持有了这个对象，标志位修改为1，就进入偏向模式，同时会把这个线程的ID记录在对象的Mark Word中。")]),s._v(" "),t("p",[t("strong",[s._v("【偏向锁】")])]),s._v(" "),t("p",[s._v("以后该线程进入和退出同步代码块不需要进行CAS 操作来加锁和解锁，只需要判断对象头的Mark word内是否存储指向当前线程的"),t("strong",[s._v("偏向锁")]),s._v("。如果有表示已经获得锁，如果没有或者不是，则需要使用CAS进行替换；如果设置成功则当前线程持有偏向锁，反之将偏向锁进行撤销并升级为轻量级锁。")]),s._v(" "),t("blockquote",[t("p",[s._v("偏向锁不会释放锁（大华被问到过，答错了…）")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617213014.png",alt:"6140"}})]),s._v(" "),t("p",[t("strong",[s._v("【轻量级锁加锁过程】")])]),s._v(" "),t("p",[s._v("线程在执行同步块之前，JVM会在当前线程的栈帧中创建用于存储锁记录的空间，并将对象头的Mark Word复制到锁记录(Displaced Mark Word)中，然后线程尝试使用CAS 将对象头中的Mark Word替换为指向锁记录的指针。")]),s._v(" "),t("ul",[t("li",[s._v("如果成功，当前线程获得锁，")]),s._v(" "),t("li",[s._v("反之表示其他线程竞争锁，当前线程便尝试使用"),t("strong",[s._v("自旋")]),s._v("来获得锁")])]),s._v(" "),t("p",[t("strong",[s._v("【自旋-防止上下文切换】")])]),s._v(" "),t("p",[s._v("Linux系统的用户态和内核态的切换很耗资源，其实就是线程的等待唤起过程。")]),s._v(" "),t("p",[s._v("为了减少开销，提高效率，"),t("strong",[s._v("会短暂的自旋防止线程被切换挂起！")])]),s._v(" "),t("p",[s._v("自旋，过来的线程在不断自旋，防止线程被挂起。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("一旦可以获取资源，就直接尝试成功，")])]),s._v(" "),t("li",[t("p",[s._v("直到超出阈值仍然没获取到，自旋锁的默认大小是10次，自旋都失败了。那就升级为重量级的锁，像1.5的一样，等待唤起咯。")])])]),s._v(" "),t("blockquote",[t("p",[s._v("-XX：PreBlockSpin可以修改")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-later/20210617213020.png",alt:"1640"}})]),s._v(" "),t("p",[t("strong",[s._v("【重量级锁】")])]),s._v(" "),t("p",[s._v("当前线程获取到锁，其他线程处于阻塞中")]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"偏向锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#偏向锁"}},[s._v("#")]),s._v(" 偏向锁")]),s._v(" "),t("p",[s._v("JDK 1.6 之后默认synchronized")]),s._v(" "),t("p",[s._v("最乐观的锁：进入同步块或同步方法始终是一个线程")]),s._v(" "),t("p",[s._v("在不同时刻时，当出现另一个线程也尝试获取锁，偏向锁会升级为轻量级锁")]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"轻量级锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#轻量级锁"}},[s._v("#")]),s._v(" 轻量级锁")]),s._v(" "),t("ul",[t("li",[s._v("不同时刻有不同的线程获取锁，基本不存在锁竞争")]),s._v(" "),t("li",[s._v("同一时刻，如果不同线程尝试获取锁，会将偏向锁自动升级为重量级锁")])]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"重量级锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#重量级锁"}},[s._v("#")]),s._v(" 重量级锁")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("JDK 1.6 之前的锁都是重量级锁，将线程阻塞挂起")])]),s._v(" "),t("li",[t("p",[s._v("锁只有升级过程，没有降级")])])]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"锁粗化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁粗化"}},[s._v("#")]),s._v(" 锁粗化")]),s._v(" "),t("p",[s._v("将多次连接在一起的加锁、解锁操作合并为一次，将多个连续的锁扩展成为一个范围更大的锁")]),s._v(" "),t("p",[s._v("比如使用StringBuffer中的apperd方法来添加字符串")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("sb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("append")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"a"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("append")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("append")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("这里每次调用append方法都需要加锁和解锁操作")]),s._v(" "),t("p",[s._v("如果虚拟机检测到有一系列连串对同一个对象加锁和解锁操作，就会将其合并成一次范围更大的加锁和解锁操作，即在第一次"),t("code",[s._v("append")]),s._v("方法时进行加锁，最后一次"),t("code",[s._v("append")]),s._v("方法结束后进行解锁")]),s._v(" "),t("hr"),s._v(" "),t("h3",{attrs:{id:"锁消除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁消除"}},[s._v("#")]),s._v(" 锁消除")]),s._v(" "),t("p",[s._v("当对象不属于共享资源时，对象内部的同步方法或同步代码块的锁会被自动解除")]),s._v(" "),t("p",[s._v("​    "),t("br")]),s._v(" "),t("h2",{attrs:{id:"_5-用synchronized还是lock"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-用synchronized还是lock"}},[s._v("#")]),s._v(" 5. 用synchronized还是Lock")]),s._v(" "),t("ul",[t("li",[s._v("synchronized是关键字，是JVM层面的底层啥都帮我们做了，而Lock是一个接口，是JDK层面的有丰富的API。")]),s._v(" "),t("li",[s._v("synchronized会自动释放锁，而Lock必须手动释放锁。")]),s._v(" "),t("li",[s._v("synchronized是不可中断的，Lock可以中断也可以不中断。")]),s._v(" "),t("li",[s._v("通过Lock可以知道线程有没有拿到锁，而synchronized不能。")]),s._v(" "),t("li",[s._v("synchronized能锁住方法和代码块，而Lock只能锁住代码块。")]),s._v(" "),t("li",[s._v("Lock可以使用读锁提高多线程读效率。")]),s._v(" "),t("li",[s._v("synchronized是非公平锁，ReentrantLock可以控制是否是公平锁。")])]),s._v(" "),t("p",[s._v("两者一个是JDK层面的一个是JVM层面的，我觉得最大的区别其实在，我们是否需要丰富的api，还有一个我们的场景。")]),s._v(" "),t("p",[t("strong",[s._v("比如我现在是滴滴，我早上有打车高峰，我代码使用了大量的synchronized，有什么问题？锁升级过程是不可逆的，过了高峰我们还是重量级的锁，那效率是不是大打折扣了？这个时候你用Lock是不是很好？")])]),s._v(" "),t("blockquote",[t("p",[s._v("场景是一定要考虑的，我现在告诉你哪个好都是扯淡，因为脱离了业务，一切技术讨论都没有了价值。")])])])}),[],!1,null,null,null);t.default=r.exports}}]);