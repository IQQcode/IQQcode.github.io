<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>拦截器详解2(重点)：连接、请求服务-转载 | icode</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="iqqcode个人技术博客,Android开发,计算机基础知识,Java后端,Android面试题,技术文档,学习,面试,Java,Kotlin,Android,Android UI,python,Git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.ceb4cb47.css" as="style"><link rel="preload" href="/assets/js/app.c4fffd9b.js" as="script"><link rel="preload" href="/assets/js/2.9f83a926.js" as="script"><link rel="preload" href="/assets/js/101.d3a4a836.js" as="script"><link rel="prefetch" href="/assets/js/10.35c68bd0.js"><link rel="prefetch" href="/assets/js/100.90029d0b.js"><link rel="prefetch" href="/assets/js/102.a727386c.js"><link rel="prefetch" href="/assets/js/103.bc3fb8dc.js"><link rel="prefetch" href="/assets/js/104.9bfa15e7.js"><link rel="prefetch" href="/assets/js/105.cdcf3a6f.js"><link rel="prefetch" href="/assets/js/106.6bad5396.js"><link rel="prefetch" href="/assets/js/107.4d3eef3f.js"><link rel="prefetch" href="/assets/js/108.86b992c6.js"><link rel="prefetch" href="/assets/js/109.8a12806a.js"><link rel="prefetch" href="/assets/js/11.a1e4f728.js"><link rel="prefetch" href="/assets/js/110.6fcaaa50.js"><link rel="prefetch" href="/assets/js/111.cb6ed118.js"><link rel="prefetch" href="/assets/js/112.06fd92bb.js"><link rel="prefetch" href="/assets/js/113.5f32a60d.js"><link rel="prefetch" href="/assets/js/114.95abdc5b.js"><link rel="prefetch" href="/assets/js/115.ed9bd926.js"><link rel="prefetch" href="/assets/js/116.2cac1d58.js"><link rel="prefetch" href="/assets/js/117.83a57bca.js"><link rel="prefetch" href="/assets/js/118.57515045.js"><link rel="prefetch" href="/assets/js/119.7600fea0.js"><link rel="prefetch" href="/assets/js/12.5a87478f.js"><link rel="prefetch" href="/assets/js/120.c74a52a0.js"><link rel="prefetch" href="/assets/js/121.7e1c0bdd.js"><link rel="prefetch" href="/assets/js/122.0be034a9.js"><link rel="prefetch" href="/assets/js/123.1be06ae4.js"><link rel="prefetch" href="/assets/js/124.8541e25e.js"><link rel="prefetch" href="/assets/js/125.a1a7e6d1.js"><link rel="prefetch" href="/assets/js/126.c2bb4416.js"><link rel="prefetch" href="/assets/js/127.268b10c1.js"><link rel="prefetch" href="/assets/js/128.9c0f2ae5.js"><link rel="prefetch" href="/assets/js/129.12aab14b.js"><link rel="prefetch" href="/assets/js/13.9eb96038.js"><link rel="prefetch" href="/assets/js/130.98cacaf5.js"><link rel="prefetch" href="/assets/js/131.2345cb8f.js"><link rel="prefetch" href="/assets/js/132.7db7293c.js"><link rel="prefetch" href="/assets/js/133.7f46cc1e.js"><link rel="prefetch" href="/assets/js/134.5c48b209.js"><link rel="prefetch" href="/assets/js/135.8b7f0f3f.js"><link rel="prefetch" href="/assets/js/136.f2ed8038.js"><link rel="prefetch" href="/assets/js/137.a7b6de88.js"><link rel="prefetch" href="/assets/js/138.0e892244.js"><link rel="prefetch" href="/assets/js/139.cc2a4fe5.js"><link rel="prefetch" href="/assets/js/14.de3651da.js"><link rel="prefetch" href="/assets/js/140.9c4150d0.js"><link rel="prefetch" href="/assets/js/141.e00b8913.js"><link rel="prefetch" href="/assets/js/142.55fe8f39.js"><link rel="prefetch" href="/assets/js/143.380e795b.js"><link rel="prefetch" href="/assets/js/144.b892c909.js"><link rel="prefetch" href="/assets/js/145.48e9e594.js"><link rel="prefetch" href="/assets/js/146.1909038d.js"><link rel="prefetch" href="/assets/js/147.f81a66fb.js"><link rel="prefetch" href="/assets/js/148.fb68c2e3.js"><link rel="prefetch" href="/assets/js/149.5a794e49.js"><link rel="prefetch" href="/assets/js/15.9cc8357f.js"><link rel="prefetch" href="/assets/js/150.870a3a84.js"><link rel="prefetch" href="/assets/js/151.67613ad8.js"><link rel="prefetch" href="/assets/js/152.eb9a6177.js"><link rel="prefetch" href="/assets/js/153.2742ce68.js"><link rel="prefetch" href="/assets/js/154.29650726.js"><link rel="prefetch" href="/assets/js/155.a4a4e09e.js"><link rel="prefetch" href="/assets/js/156.c89921ba.js"><link rel="prefetch" href="/assets/js/157.4b583e23.js"><link rel="prefetch" href="/assets/js/158.200d5c17.js"><link rel="prefetch" href="/assets/js/159.8e38aae7.js"><link rel="prefetch" href="/assets/js/16.f44bd57c.js"><link rel="prefetch" href="/assets/js/160.8f6a94ab.js"><link rel="prefetch" href="/assets/js/161.da1a4a22.js"><link rel="prefetch" href="/assets/js/162.53662266.js"><link rel="prefetch" href="/assets/js/163.6230fe0f.js"><link rel="prefetch" href="/assets/js/164.3fc004f1.js"><link rel="prefetch" href="/assets/js/165.7de0f4a6.js"><link rel="prefetch" href="/assets/js/166.ecca032e.js"><link rel="prefetch" href="/assets/js/167.e1018c98.js"><link rel="prefetch" href="/assets/js/168.a7b1869a.js"><link rel="prefetch" href="/assets/js/169.72667f5d.js"><link rel="prefetch" href="/assets/js/17.39d5e4ad.js"><link rel="prefetch" href="/assets/js/170.b95bf15a.js"><link rel="prefetch" href="/assets/js/171.9c045011.js"><link rel="prefetch" href="/assets/js/172.d4720e4e.js"><link rel="prefetch" href="/assets/js/173.96fbff3b.js"><link rel="prefetch" href="/assets/js/174.31dbd100.js"><link rel="prefetch" href="/assets/js/175.66bff00d.js"><link rel="prefetch" href="/assets/js/176.a811fba7.js"><link rel="prefetch" href="/assets/js/177.a1acb18f.js"><link rel="prefetch" href="/assets/js/178.a13da04f.js"><link rel="prefetch" href="/assets/js/179.70b45d97.js"><link rel="prefetch" href="/assets/js/18.c4df36af.js"><link rel="prefetch" href="/assets/js/180.cb8e96c1.js"><link rel="prefetch" href="/assets/js/181.5bc25898.js"><link rel="prefetch" href="/assets/js/182.914c3d49.js"><link rel="prefetch" href="/assets/js/183.cdee2109.js"><link rel="prefetch" href="/assets/js/184.a4a94f17.js"><link rel="prefetch" href="/assets/js/185.53c0dc11.js"><link rel="prefetch" href="/assets/js/186.ae181b5e.js"><link rel="prefetch" href="/assets/js/187.4a131e58.js"><link rel="prefetch" href="/assets/js/188.3f0c3f36.js"><link rel="prefetch" href="/assets/js/189.735dd8f4.js"><link rel="prefetch" href="/assets/js/19.8b20b983.js"><link rel="prefetch" href="/assets/js/190.b715ee6b.js"><link rel="prefetch" href="/assets/js/191.1a21480c.js"><link rel="prefetch" href="/assets/js/192.f1a764e7.js"><link rel="prefetch" href="/assets/js/193.a5b89957.js"><link rel="prefetch" href="/assets/js/194.4387950a.js"><link rel="prefetch" href="/assets/js/195.a65d434d.js"><link rel="prefetch" href="/assets/js/196.bb7b9cc4.js"><link rel="prefetch" href="/assets/js/197.0965e3ef.js"><link rel="prefetch" href="/assets/js/198.db6cc7b3.js"><link rel="prefetch" href="/assets/js/199.efd7c0e1.js"><link rel="prefetch" href="/assets/js/20.56028c13.js"><link rel="prefetch" href="/assets/js/200.740e0229.js"><link rel="prefetch" href="/assets/js/201.3aeee16c.js"><link rel="prefetch" href="/assets/js/202.cb2c5cc3.js"><link rel="prefetch" href="/assets/js/203.53493d70.js"><link rel="prefetch" href="/assets/js/204.b0455d4f.js"><link rel="prefetch" href="/assets/js/205.5be45085.js"><link rel="prefetch" href="/assets/js/206.638f016a.js"><link rel="prefetch" href="/assets/js/207.3aed7b71.js"><link rel="prefetch" href="/assets/js/208.9968d45e.js"><link rel="prefetch" href="/assets/js/209.43dda282.js"><link rel="prefetch" href="/assets/js/21.cb9ec569.js"><link rel="prefetch" href="/assets/js/210.562cae7a.js"><link rel="prefetch" href="/assets/js/211.f6990922.js"><link rel="prefetch" href="/assets/js/212.4160ee69.js"><link rel="prefetch" href="/assets/js/213.51929c5d.js"><link rel="prefetch" href="/assets/js/214.55f87ee8.js"><link rel="prefetch" href="/assets/js/215.5cf2688f.js"><link rel="prefetch" href="/assets/js/216.fa3f6e08.js"><link rel="prefetch" href="/assets/js/217.030e1227.js"><link rel="prefetch" href="/assets/js/218.0b65ded2.js"><link rel="prefetch" href="/assets/js/219.24e0a3e2.js"><link rel="prefetch" href="/assets/js/22.4d680d57.js"><link rel="prefetch" href="/assets/js/220.acb78f61.js"><link rel="prefetch" href="/assets/js/221.7155683c.js"><link rel="prefetch" href="/assets/js/222.dfe2f66a.js"><link rel="prefetch" href="/assets/js/223.43dcc775.js"><link rel="prefetch" href="/assets/js/224.478f37dd.js"><link rel="prefetch" href="/assets/js/225.c66e7675.js"><link rel="prefetch" href="/assets/js/226.52132969.js"><link rel="prefetch" href="/assets/js/227.007e41ac.js"><link rel="prefetch" href="/assets/js/228.5df8ae2b.js"><link rel="prefetch" href="/assets/js/229.36696c6e.js"><link rel="prefetch" href="/assets/js/23.c61706fd.js"><link rel="prefetch" href="/assets/js/230.5f013e25.js"><link rel="prefetch" href="/assets/js/231.2d867015.js"><link rel="prefetch" href="/assets/js/232.f0dc43b6.js"><link rel="prefetch" href="/assets/js/233.30b764c1.js"><link rel="prefetch" href="/assets/js/234.5469a470.js"><link rel="prefetch" href="/assets/js/235.931c5096.js"><link rel="prefetch" href="/assets/js/236.3efa0639.js"><link rel="prefetch" href="/assets/js/237.df6eeb81.js"><link rel="prefetch" href="/assets/js/238.86870cd9.js"><link rel="prefetch" href="/assets/js/239.0dea9f43.js"><link rel="prefetch" href="/assets/js/24.34b0677f.js"><link rel="prefetch" href="/assets/js/240.2a1ba3eb.js"><link rel="prefetch" href="/assets/js/241.a432633f.js"><link rel="prefetch" href="/assets/js/242.930a9ae0.js"><link rel="prefetch" href="/assets/js/243.ba2f54e1.js"><link rel="prefetch" href="/assets/js/244.baf03f3a.js"><link rel="prefetch" href="/assets/js/245.bbb30308.js"><link rel="prefetch" href="/assets/js/246.d8220e2c.js"><link rel="prefetch" href="/assets/js/247.0d603794.js"><link rel="prefetch" href="/assets/js/248.7157409f.js"><link rel="prefetch" href="/assets/js/249.946ae3ae.js"><link rel="prefetch" href="/assets/js/25.7fe03aa6.js"><link rel="prefetch" href="/assets/js/250.08256dc2.js"><link rel="prefetch" href="/assets/js/251.d963de19.js"><link rel="prefetch" href="/assets/js/252.37750e79.js"><link rel="prefetch" href="/assets/js/253.cf32370d.js"><link rel="prefetch" href="/assets/js/254.34f6e896.js"><link rel="prefetch" href="/assets/js/255.56a6d6e9.js"><link rel="prefetch" href="/assets/js/256.c6fdb820.js"><link rel="prefetch" href="/assets/js/257.ce6a0cac.js"><link rel="prefetch" href="/assets/js/258.2a100981.js"><link rel="prefetch" href="/assets/js/259.dac64042.js"><link rel="prefetch" href="/assets/js/26.edbdf302.js"><link rel="prefetch" href="/assets/js/260.769008f3.js"><link rel="prefetch" href="/assets/js/261.0d396fd2.js"><link rel="prefetch" href="/assets/js/262.09f85e25.js"><link rel="prefetch" href="/assets/js/263.4c7a3bcd.js"><link rel="prefetch" href="/assets/js/264.db180a43.js"><link rel="prefetch" href="/assets/js/265.cc07c5f1.js"><link rel="prefetch" href="/assets/js/266.55b1d837.js"><link rel="prefetch" href="/assets/js/267.25065a31.js"><link rel="prefetch" href="/assets/js/268.bebd196a.js"><link rel="prefetch" href="/assets/js/269.497125cb.js"><link rel="prefetch" href="/assets/js/27.467a6179.js"><link rel="prefetch" href="/assets/js/270.01119896.js"><link rel="prefetch" href="/assets/js/271.92babc4c.js"><link rel="prefetch" href="/assets/js/272.4f8f8723.js"><link rel="prefetch" href="/assets/js/273.b032f89e.js"><link rel="prefetch" href="/assets/js/274.24f82320.js"><link rel="prefetch" href="/assets/js/275.870fff68.js"><link rel="prefetch" href="/assets/js/276.656145f5.js"><link rel="prefetch" href="/assets/js/277.4e823ccb.js"><link rel="prefetch" href="/assets/js/278.74c4b649.js"><link rel="prefetch" href="/assets/js/279.c15e38a3.js"><link rel="prefetch" href="/assets/js/28.19f83fa5.js"><link rel="prefetch" href="/assets/js/280.1f00b03b.js"><link rel="prefetch" href="/assets/js/281.5f7e9149.js"><link rel="prefetch" href="/assets/js/282.886a0af3.js"><link rel="prefetch" href="/assets/js/283.c6c6fab5.js"><link rel="prefetch" href="/assets/js/284.9edef1d1.js"><link rel="prefetch" href="/assets/js/285.dc3a5432.js"><link rel="prefetch" href="/assets/js/286.138bef72.js"><link rel="prefetch" href="/assets/js/287.f76e370f.js"><link rel="prefetch" href="/assets/js/288.78c2980b.js"><link rel="prefetch" href="/assets/js/289.ec0893c0.js"><link rel="prefetch" href="/assets/js/29.6b9a37af.js"><link rel="prefetch" href="/assets/js/290.cc9e0935.js"><link rel="prefetch" href="/assets/js/291.8ced75e3.js"><link rel="prefetch" href="/assets/js/292.053648f2.js"><link rel="prefetch" href="/assets/js/293.0b8824b2.js"><link rel="prefetch" href="/assets/js/294.734997d8.js"><link rel="prefetch" href="/assets/js/295.3e11be76.js"><link rel="prefetch" href="/assets/js/296.6450d200.js"><link rel="prefetch" href="/assets/js/297.8f3a33db.js"><link rel="prefetch" href="/assets/js/298.c956c547.js"><link rel="prefetch" href="/assets/js/299.6b94a182.js"><link rel="prefetch" href="/assets/js/3.f761a838.js"><link rel="prefetch" href="/assets/js/30.386e021a.js"><link rel="prefetch" href="/assets/js/300.bcfc8f68.js"><link rel="prefetch" href="/assets/js/301.87eecddb.js"><link rel="prefetch" href="/assets/js/302.30c8944c.js"><link rel="prefetch" href="/assets/js/303.bf7fb9ce.js"><link rel="prefetch" href="/assets/js/304.b2262ab2.js"><link rel="prefetch" href="/assets/js/305.44e232f5.js"><link rel="prefetch" href="/assets/js/306.5d2b7ffa.js"><link rel="prefetch" href="/assets/js/307.9f31c9b9.js"><link rel="prefetch" href="/assets/js/308.7ff47fdb.js"><link rel="prefetch" href="/assets/js/309.6c4aa72f.js"><link rel="prefetch" href="/assets/js/31.6c065972.js"><link rel="prefetch" href="/assets/js/310.2dd6a183.js"><link rel="prefetch" href="/assets/js/311.8d1cffab.js"><link rel="prefetch" href="/assets/js/312.07c6f635.js"><link rel="prefetch" href="/assets/js/313.a3216bc7.js"><link rel="prefetch" href="/assets/js/314.f6f9f3b7.js"><link rel="prefetch" href="/assets/js/315.8c803181.js"><link rel="prefetch" href="/assets/js/316.66f99d15.js"><link rel="prefetch" href="/assets/js/317.27276d98.js"><link rel="prefetch" href="/assets/js/318.82d40360.js"><link rel="prefetch" href="/assets/js/319.de3a362a.js"><link rel="prefetch" href="/assets/js/32.84c9ff75.js"><link rel="prefetch" href="/assets/js/320.8bfa4101.js"><link rel="prefetch" href="/assets/js/321.4bcee5bd.js"><link rel="prefetch" href="/assets/js/322.c7bca23d.js"><link rel="prefetch" href="/assets/js/323.d9790358.js"><link rel="prefetch" href="/assets/js/324.6cd9ebf7.js"><link rel="prefetch" href="/assets/js/325.0262b0e8.js"><link rel="prefetch" href="/assets/js/326.7aa599e0.js"><link rel="prefetch" href="/assets/js/327.07d10552.js"><link rel="prefetch" href="/assets/js/328.21e79c11.js"><link rel="prefetch" href="/assets/js/329.b99baa18.js"><link rel="prefetch" href="/assets/js/33.d26609c0.js"><link rel="prefetch" href="/assets/js/330.f8e23d39.js"><link rel="prefetch" href="/assets/js/331.3e42539e.js"><link rel="prefetch" href="/assets/js/332.5310bf8f.js"><link rel="prefetch" href="/assets/js/333.7397ddfb.js"><link rel="prefetch" href="/assets/js/334.58bfa4df.js"><link rel="prefetch" href="/assets/js/335.e81da0ef.js"><link rel="prefetch" href="/assets/js/336.e3893cd1.js"><link rel="prefetch" href="/assets/js/337.9836527e.js"><link rel="prefetch" href="/assets/js/338.14b79adb.js"><link rel="prefetch" href="/assets/js/339.6f37c4c7.js"><link rel="prefetch" href="/assets/js/34.025a1886.js"><link rel="prefetch" href="/assets/js/340.493519a3.js"><link rel="prefetch" href="/assets/js/341.cc5047d3.js"><link rel="prefetch" href="/assets/js/342.a2d40ca4.js"><link rel="prefetch" href="/assets/js/343.99a1b5f2.js"><link rel="prefetch" href="/assets/js/344.221ddc73.js"><link rel="prefetch" href="/assets/js/345.0078be11.js"><link rel="prefetch" href="/assets/js/346.b49c191d.js"><link rel="prefetch" href="/assets/js/347.c8756936.js"><link rel="prefetch" href="/assets/js/348.d5c6fc58.js"><link rel="prefetch" href="/assets/js/349.b0440c29.js"><link rel="prefetch" href="/assets/js/35.52fa0766.js"><link rel="prefetch" href="/assets/js/350.a12ad7d3.js"><link rel="prefetch" href="/assets/js/351.c5f28d09.js"><link rel="prefetch" href="/assets/js/352.2b2a29c3.js"><link rel="prefetch" href="/assets/js/353.1353338b.js"><link rel="prefetch" href="/assets/js/354.f5a55086.js"><link rel="prefetch" href="/assets/js/355.74f419ac.js"><link rel="prefetch" href="/assets/js/356.b238d52b.js"><link rel="prefetch" href="/assets/js/357.66d3ef13.js"><link rel="prefetch" href="/assets/js/358.39e9b3c6.js"><link rel="prefetch" href="/assets/js/359.de2e8673.js"><link rel="prefetch" href="/assets/js/36.b19941a9.js"><link rel="prefetch" href="/assets/js/360.7c6a09c1.js"><link rel="prefetch" href="/assets/js/361.333022d4.js"><link rel="prefetch" href="/assets/js/362.a29e1f99.js"><link rel="prefetch" href="/assets/js/363.89f3677d.js"><link rel="prefetch" href="/assets/js/364.ab1b9569.js"><link rel="prefetch" href="/assets/js/365.6d755256.js"><link rel="prefetch" href="/assets/js/366.cf2dcd95.js"><link rel="prefetch" href="/assets/js/367.7c94d893.js"><link rel="prefetch" href="/assets/js/368.eabc3b91.js"><link rel="prefetch" href="/assets/js/369.fd1df925.js"><link rel="prefetch" href="/assets/js/37.11451496.js"><link rel="prefetch" href="/assets/js/370.425a913b.js"><link rel="prefetch" href="/assets/js/371.3f270c04.js"><link rel="prefetch" href="/assets/js/372.ad47799b.js"><link rel="prefetch" href="/assets/js/373.3f422c31.js"><link rel="prefetch" href="/assets/js/374.0cf0a589.js"><link rel="prefetch" href="/assets/js/375.1c1b93be.js"><link rel="prefetch" href="/assets/js/376.31174f57.js"><link rel="prefetch" href="/assets/js/377.13e0af89.js"><link rel="prefetch" href="/assets/js/378.8737a4a8.js"><link rel="prefetch" href="/assets/js/379.2a0a2812.js"><link rel="prefetch" href="/assets/js/38.173841cb.js"><link rel="prefetch" href="/assets/js/380.aab2ba84.js"><link rel="prefetch" href="/assets/js/381.5615c04c.js"><link rel="prefetch" href="/assets/js/382.d90ab831.js"><link rel="prefetch" href="/assets/js/383.9a4bbb6d.js"><link rel="prefetch" href="/assets/js/384.ea3aba84.js"><link rel="prefetch" href="/assets/js/385.75f0710a.js"><link rel="prefetch" href="/assets/js/386.ca2718e9.js"><link rel="prefetch" href="/assets/js/387.354d21ef.js"><link rel="prefetch" href="/assets/js/388.d9045b2a.js"><link rel="prefetch" href="/assets/js/389.25413a63.js"><link rel="prefetch" href="/assets/js/39.b2127679.js"><link rel="prefetch" href="/assets/js/390.ed551fe3.js"><link rel="prefetch" href="/assets/js/391.a067cc14.js"><link rel="prefetch" href="/assets/js/392.5ab90332.js"><link rel="prefetch" href="/assets/js/393.4f3c33b3.js"><link rel="prefetch" href="/assets/js/394.03ca395f.js"><link rel="prefetch" href="/assets/js/395.a3635303.js"><link rel="prefetch" href="/assets/js/396.b0a48716.js"><link rel="prefetch" href="/assets/js/397.645e7967.js"><link rel="prefetch" href="/assets/js/398.2e68f658.js"><link rel="prefetch" href="/assets/js/399.12074550.js"><link rel="prefetch" href="/assets/js/4.57f396da.js"><link rel="prefetch" href="/assets/js/40.6289e1b3.js"><link rel="prefetch" href="/assets/js/400.fda61f98.js"><link rel="prefetch" href="/assets/js/401.dbab358c.js"><link rel="prefetch" href="/assets/js/402.ce374870.js"><link rel="prefetch" href="/assets/js/403.c1141a30.js"><link rel="prefetch" href="/assets/js/404.1eca5fa9.js"><link rel="prefetch" href="/assets/js/405.007474ef.js"><link rel="prefetch" href="/assets/js/406.9ef3bf8f.js"><link rel="prefetch" href="/assets/js/407.49d0a838.js"><link rel="prefetch" href="/assets/js/408.62ce874a.js"><link rel="prefetch" href="/assets/js/409.acb83f82.js"><link rel="prefetch" href="/assets/js/41.dc6d13ae.js"><link rel="prefetch" href="/assets/js/410.ded2fe8b.js"><link rel="prefetch" href="/assets/js/411.101dd5a9.js"><link rel="prefetch" href="/assets/js/412.3ebc70ac.js"><link rel="prefetch" href="/assets/js/413.e8ab2c41.js"><link rel="prefetch" href="/assets/js/414.1ec2e69b.js"><link rel="prefetch" href="/assets/js/42.4b8c4d77.js"><link rel="prefetch" href="/assets/js/43.8074f136.js"><link rel="prefetch" href="/assets/js/44.0275be6d.js"><link rel="prefetch" href="/assets/js/45.09292bde.js"><link rel="prefetch" href="/assets/js/46.b0087dec.js"><link rel="prefetch" href="/assets/js/47.11ebc4d0.js"><link rel="prefetch" href="/assets/js/48.930ca5b3.js"><link rel="prefetch" href="/assets/js/49.bfff3941.js"><link rel="prefetch" href="/assets/js/5.77a423bf.js"><link rel="prefetch" href="/assets/js/50.5984f99a.js"><link rel="prefetch" href="/assets/js/51.5d81104f.js"><link rel="prefetch" href="/assets/js/52.8a0beb32.js"><link rel="prefetch" href="/assets/js/53.938a2cbe.js"><link rel="prefetch" href="/assets/js/54.72bd128c.js"><link rel="prefetch" href="/assets/js/55.1bc73709.js"><link rel="prefetch" href="/assets/js/56.b9c5dcc8.js"><link rel="prefetch" href="/assets/js/57.55cec04f.js"><link rel="prefetch" href="/assets/js/58.56fe85fa.js"><link rel="prefetch" href="/assets/js/59.afa1b570.js"><link rel="prefetch" href="/assets/js/6.6f760c85.js"><link rel="prefetch" href="/assets/js/60.9ce60716.js"><link rel="prefetch" href="/assets/js/61.e70528d5.js"><link rel="prefetch" href="/assets/js/62.61236470.js"><link rel="prefetch" href="/assets/js/63.40581113.js"><link rel="prefetch" href="/assets/js/64.e2504c75.js"><link rel="prefetch" href="/assets/js/65.64bb7a47.js"><link rel="prefetch" href="/assets/js/66.3478c00a.js"><link rel="prefetch" href="/assets/js/67.9a47a41e.js"><link rel="prefetch" href="/assets/js/68.3dd8a6c5.js"><link rel="prefetch" href="/assets/js/69.9bdb8207.js"><link rel="prefetch" href="/assets/js/7.82dedd58.js"><link rel="prefetch" href="/assets/js/70.3ffe5f25.js"><link rel="prefetch" href="/assets/js/71.3bf8df7d.js"><link rel="prefetch" href="/assets/js/72.10b3c317.js"><link rel="prefetch" href="/assets/js/73.7028d713.js"><link rel="prefetch" href="/assets/js/74.c2b3f69c.js"><link rel="prefetch" href="/assets/js/75.31241789.js"><link rel="prefetch" href="/assets/js/76.9dbde09c.js"><link rel="prefetch" href="/assets/js/77.2e13b50c.js"><link rel="prefetch" href="/assets/js/78.42d1386b.js"><link rel="prefetch" href="/assets/js/79.235c6f12.js"><link rel="prefetch" href="/assets/js/8.b0e435f5.js"><link rel="prefetch" href="/assets/js/80.7aaf7b85.js"><link rel="prefetch" href="/assets/js/81.cc38248a.js"><link rel="prefetch" href="/assets/js/82.a209ca7b.js"><link rel="prefetch" href="/assets/js/83.3fbc5318.js"><link rel="prefetch" href="/assets/js/84.85465c0d.js"><link rel="prefetch" href="/assets/js/85.144fa5bc.js"><link rel="prefetch" href="/assets/js/86.0c263e44.js"><link rel="prefetch" href="/assets/js/87.a33b9020.js"><link rel="prefetch" href="/assets/js/88.adfbb198.js"><link rel="prefetch" href="/assets/js/89.2c3492d3.js"><link rel="prefetch" href="/assets/js/9.b918cea6.js"><link rel="prefetch" href="/assets/js/90.6743afe4.js"><link rel="prefetch" href="/assets/js/91.8bbf02d4.js"><link rel="prefetch" href="/assets/js/92.b1a26755.js"><link rel="prefetch" href="/assets/js/93.e6a56250.js"><link rel="prefetch" href="/assets/js/94.1e4b20df.js"><link rel="prefetch" href="/assets/js/95.27eb582f.js"><link rel="prefetch" href="/assets/js/96.a1afc1be.js"><link rel="prefetch" href="/assets/js/97.0193aee5.js"><link rel="prefetch" href="/assets/js/98.67d6298c.js"><link rel="prefetch" href="/assets/js/99.28bb5346.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ceb4cb47.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/icode-logo.png" alt="icode" class="logo"> <span class="site-name can-hide">icode</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Android" class="dropdown-title"><a href="/android/" class="link-title">Android</a> <span class="title" style="display:none;">Android</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Android学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/51b303/" class="nav-link">📁基础内容</a></li><li class="dropdown-subitem"><a href="/pages/3e134f/" class="nav-link">📺AndroidCore</a></li><li class="dropdown-subitem"><a href="/pages/e4a74c/" class="nav-link">🎨Android-UI</a></li><li class="dropdown-subitem"><a href="/pages/49df9e/" class="nav-link">🏖️Components</a></li><li class="dropdown-subitem"><a href="/pages/95e963/" class="nav-link">📊Fragment</a></li><li class="dropdown-subitem"><a href="/pages/7ba642/" class="nav-link">🔗网络操作</a></li><li class="dropdown-subitem"><a href="/pages/83b5b7/" class="nav-link">🔏异步机制</a></li><li class="dropdown-subitem"><a href="/pages/eecb9c/" class="nav-link">📦数据存储</a></li><li class="dropdown-subitem"><a href="/pages/eecb9c/" class="nav-link">🗃️Gradle</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/frame/" class="nav-link">『框架』笔记</a></li><li class="dropdown-subitem"><a href="/note/kotlin/" class="nav-link">『Kotlin』笔记</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》笔记</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》学习笔记</a></li><li class="dropdown-subitem"><a href="/note/bug/" class="nav-link">『Bug踩坑记录』</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Component" class="dropdown-title"><a href="/component/" class="link-title">Component</a> <span class="title" style="display:none;">Component</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/04bab7/" class="nav-link">ListView</a></li><li class="dropdown-item"><!----> <a href="/pages/e51974/" class="nav-link">RecyclerView</a></li><li class="dropdown-item"><!----> <a href="/pages/2074bf/" class="nav-link">ViewPager</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java后端" class="dropdown-title"><a href="/java/" class="link-title">Java后端</a> <span class="title" style="display:none;">Java后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b003f8/" class="nav-link">🟠JavaSE</a></li><li class="dropdown-subitem"><a href="/pages/d65d4f/" class="nav-link">🟢JavaWeb</a></li><li class="dropdown-subitem"><a href="/pages/f7d1fe/" class="nav-link">🔴JavaEE</a></li><li class="dropdown-subitem"><a href="/pages/78e80a/" class="nav-link">⚪JavaTopic</a></li><li class="dropdown-subitem"><a href="/pages/1ce44e/" class="nav-link">🍳设计模式</a></li></ul></li><li class="dropdown-item"><h4>计算机基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/csnet/" class="nav-link">📌计算机网络</a></li><li class="dropdown-subitem"><a href="/note/datastruct/" class="nav-link">🔍数据结构</a></li><li class="dropdown-subitem"><a href="/note/database/" class="nav-link">📦数据库</a></li><li class="dropdown-subitem"><a href="/note/os/" class="nav-link">💻OS</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="About" class="dropdown-title"><a href="/about/" class="link-title">About</a> <span class="title" style="display:none;">About</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>关于</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/1cbe0d/" class="nav-link">📫关于我</a></li></ul></li><li class="dropdown-item"><h4>收藏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-subitem"><a href="/pages/eee83a9211a70f9d/" class="nav-link">资源</a></li><li class="dropdown-subitem"><a href="/pages/12df8ace52d493f6/" class="nav-link">Vue资源</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/iqqcode/icode" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.png"> <div class="blogger-info"><h3>iqqcode</h3> <span>保持对技术的探索实践与热爱</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Android" class="dropdown-title"><a href="/android/" class="link-title">Android</a> <span class="title" style="display:none;">Android</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Android学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/51b303/" class="nav-link">📁基础内容</a></li><li class="dropdown-subitem"><a href="/pages/3e134f/" class="nav-link">📺AndroidCore</a></li><li class="dropdown-subitem"><a href="/pages/e4a74c/" class="nav-link">🎨Android-UI</a></li><li class="dropdown-subitem"><a href="/pages/49df9e/" class="nav-link">🏖️Components</a></li><li class="dropdown-subitem"><a href="/pages/95e963/" class="nav-link">📊Fragment</a></li><li class="dropdown-subitem"><a href="/pages/7ba642/" class="nav-link">🔗网络操作</a></li><li class="dropdown-subitem"><a href="/pages/83b5b7/" class="nav-link">🔏异步机制</a></li><li class="dropdown-subitem"><a href="/pages/eecb9c/" class="nav-link">📦数据存储</a></li><li class="dropdown-subitem"><a href="/pages/eecb9c/" class="nav-link">🗃️Gradle</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/frame/" class="nav-link">『框架』笔记</a></li><li class="dropdown-subitem"><a href="/note/kotlin/" class="nav-link">『Kotlin』笔记</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》笔记</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》学习笔记</a></li><li class="dropdown-subitem"><a href="/note/bug/" class="nav-link">『Bug踩坑记录』</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Component" class="dropdown-title"><a href="/component/" class="link-title">Component</a> <span class="title" style="display:none;">Component</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/04bab7/" class="nav-link">ListView</a></li><li class="dropdown-item"><!----> <a href="/pages/e51974/" class="nav-link">RecyclerView</a></li><li class="dropdown-item"><!----> <a href="/pages/2074bf/" class="nav-link">ViewPager</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java后端" class="dropdown-title"><a href="/java/" class="link-title">Java后端</a> <span class="title" style="display:none;">Java后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b003f8/" class="nav-link">🟠JavaSE</a></li><li class="dropdown-subitem"><a href="/pages/d65d4f/" class="nav-link">🟢JavaWeb</a></li><li class="dropdown-subitem"><a href="/pages/f7d1fe/" class="nav-link">🔴JavaEE</a></li><li class="dropdown-subitem"><a href="/pages/78e80a/" class="nav-link">⚪JavaTopic</a></li><li class="dropdown-subitem"><a href="/pages/1ce44e/" class="nav-link">🍳设计模式</a></li></ul></li><li class="dropdown-item"><h4>计算机基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/csnet/" class="nav-link">📌计算机网络</a></li><li class="dropdown-subitem"><a href="/note/datastruct/" class="nav-link">🔍数据结构</a></li><li class="dropdown-subitem"><a href="/note/database/" class="nav-link">📦数据库</a></li><li class="dropdown-subitem"><a href="/note/os/" class="nav-link">💻OS</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="About" class="dropdown-title"><a href="/about/" class="link-title">About</a> <span class="title" style="display:none;">About</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>关于</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/1cbe0d/" class="nav-link">📫关于我</a></li></ul></li><li class="dropdown-item"><h4>收藏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-subitem"><a href="/pages/eee83a9211a70f9d/" class="nav-link">资源</a></li><li class="dropdown-subitem"><a href="/pages/12df8ace52d493f6/" class="nav-link">Vue资源</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/iqqcode/icode" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础内容</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AndroidCore</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Android UI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Components</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Fragment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>网络操作</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Android网络基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>OKHttp</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/7ba642/" class="sidebar-link">Android中的网络操作</a></li><li><a href="/pages/3ef4b3/" class="sidebar-link">OKHttp简介</a></li><li><a href="/pages/3e96ec/" class="sidebar-link">双任务队列机制</a></li><li><a href="/pages/879b2b/" class="sidebar-link">OKHttp拦截器</a></li><li><a href="/pages/2fa575/" class="sidebar-link">OkHttp的工作流程分析-转载</a></li><li><a href="/pages/79195c/" class="sidebar-link">拦截器详解1(重点)：重试、重定向、桥、缓存 转载</a></li><li><a href="/pages/9b4278/" aria-current="page" class="active sidebar-link">拦截器详解2(重点)：连接、请求服务-转载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/9b4278/#背景-http协议发展" class="sidebar-link">背景 - HTTP协议发展</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/9b4278/#http1-0" class="sidebar-link">HTTP1.0</a></li><li class="sidebar-sub-header level3"><a href="/pages/9b4278/#http1-1" class="sidebar-link">HTTP1.1</a></li><li class="sidebar-sub-header level3"><a href="/pages/9b4278/#http2-0" class="sidebar-link">HTTP2.0</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/9b4278/#connectinterceptor" class="sidebar-link">ConnectInterceptor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/9b4278/#exchangefinder" class="sidebar-link">ExchangeFinder</a></li><li class="sidebar-sub-header level3"><a href="/pages/9b4278/#routeselector" class="sidebar-link">RouteSelector</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/9b4278/#connectionpool" class="sidebar-link">ConnectionPool</a></li><li class="sidebar-sub-header level2"><a href="/pages/9b4278/#callserverinterceptor" class="sidebar-link">CallServerInterceptor</a></li><li class="sidebar-sub-header level2"><a href="/pages/9b4278/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/pages/b69191/" class="sidebar-link">补充</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>AsyncTask</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步机制</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据存储</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>自定义View</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>View事件体系</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Android" title="分类" data-v-06225672>Android</a></li><li data-v-06225672><a href="/categories/?category=%E7%BD%91%E7%BB%9C%E6%93%8D%E4%BD%9C" title="分类" data-v-06225672>网络操作</a></li><li data-v-06225672><a href="/categories/?category=OKHttp" title="分类" data-v-06225672>OKHttp</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/IQQcode" target="_blank" title="作者" class="beLink" data-v-06225672>iqqcode</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-06-17</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">拦截器详解2(重点)：连接、请求服务-转载<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><blockquote><p>『转载自📚<a href="https://cloud.tencent.com/developer/article/1667344" target="_blank" rel="noopener noreferrer">胡飞洋-拦截器详解2：连接、请求服务（重点）-https://cloud.tencent.com/developer/article/1667344<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>』</p></blockquote> <p>在本系列的上一篇文章<a href="http://mp.weixin.qq.com/s?__biz=MzU2NjgwNjc0NQ==&amp;mid=2247483959&amp;idx=1&amp;sn=5c24b087f49ebb561a25b252d72fe78f&amp;chksm=fca79381cbd01a975360cc8563057ada894cae600b454a6af95ca8168eda99ff2ad250f91a36&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">你想要的系列：网络请求框架OkHttp3全解系列 - （三）拦截器详解1：重试重定向、桥、缓存（重点）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中，我们分析了OkHttp拦截器链中的前三个拦截器：RetryAndFollowUpInterceptor、BridgeInterceptor、CacheInterceptor，它们在请求建立连接之前做了一些预处理。</p> <p>如果请求经过这三个拦截器后，要继续往下传递，说明是需要进行网络请求的（缓存不能直接满足），也就是今天要分析的内容——剩下的两个拦截器：ConnectInterceptor、CallServerInterceptor，分别负责 <strong>连接建立</strong>、<strong>请求服务读写</strong>。</p> <h2 id="背景-http协议发展"><a href="#背景-http协议发展" class="header-anchor">#</a> 背景 - HTTP协议发展</h2> <p>在讲解拦截器之前，我们有必要了解http协议相关背景知识，因为okhttp的网络连接正是基于此实现的。HTTP协议经历了以下三个版本阶段。</p> <h3 id="http1-0"><a href="#http1-0" class="header-anchor">#</a> HTTP1.0</h3> <p>在<strong>HTTP1.0</strong>中，一次请求 会建立一个TCP连接，请求完成后主动断开连接。这种方法的好处是简单，各个请求互不干扰。 但每次请求都会经历 3次握手、2次或4次挥手的连接建立和断开过程——极大影响网络效率和系统开销。</p> <p><img src="https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612175322.png" alt="001"></p> <center>图为http1.0</center> <h3 id="http1-1"><a href="#http1-1" class="header-anchor">#</a> HTTP1.1</h3> <p>在<strong>HTTP1.1</strong>中，解决了HTTP1.0中连接不能复用的问题，支持持久连接——使用<strong>keep-alive机制</strong>：一次HTTP请求结束后不会立即断开TCP连接，如果此时有新的HTTP请求，且其请求的Host同上次请求相同，那么会直接复用TCP连接。这样就减少了建立和关闭连接的消耗和延迟。keep-alive机制在HTTP1.1中是默认打开的——即在请求头添加：<strong>connection:keep-alive</strong>。（keep-alive不会永久保持连接，它有一个保持时间，可在不同的服务器软件（如Apache）中设定这个时间）</p> <p><img src="https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612175329.png" alt=""></p> <center>图为http1.1</center> <h3 id="http2-0"><a href="#http2-0" class="header-anchor">#</a> HTTP2.0</h3> <p>HTTP1.1中，<strong>连接的复用是串行的</strong>：一个请求建立了TCP连接，请求<strong>完成后</strong>，下一个相同host的请求继续使用这个连接。 但客户端想 <strong>同时</strong> 发起多个<strong>并行请求</strong>，那么必须建立多个TCP连接。将会产生网络延迟、增大网路开销。</p> <p>并且HTTP1.1不会压缩请求和响应报头，导致了不必要的网络流量；HTTP1.1不支持资源优先级导致底层TCP连接利用率低下。在HTTP2.0中，这些问题都会得到解决，<strong>HTTP2.0主要有以下特性</strong>：</p> <blockquote></blockquote> <ul><li>新的二进制格式（Binary Format）：http/1.x使用的是明文协议，其协议格式由三部分组成：request line，header，body，其协议解析是基于文本，但是这种方式存在天然缺陷，文本的表现形式有多样性，要做到健壮性考虑的场景必然很多，二进制则不同，只认0和1的组合；基于这种考虑，http/2.0的协议解析决定采用二进制格式，实现方便且健壮</li> <li>多路复用（MultiPlexing）：即连接共享，使用streamId用来区分请求，一个request对应一个stream并分配一个id，这样一个TCP连接上可以有多个stream，每个stream的frame可以随机的混杂在一起，接收方可以根据stream id将frame再归属到各自不同的request里面</li> <li>优先级和依赖（Priority、Dependency）：每个stream都可以设置优先级和依赖，优先级高的stream会被server优先处理和返回给客户端，stream还可以依赖其它的sub streams；优先级和依赖都是可以动态调整的，比如在APP上浏览商品列表，用户快速滑动到底部，但是前面的请求已经发出，如果不把后面的优先级设高，那么当前浏览的图片将会在最后展示出来，显然不利于用户体验</li> <li>header压缩：http2.0使用encoder来减少需要传输的header大小，通讯双方各自cache一份header fields表，既避免了重复header的传输，又减小了需要传输的大小</li> <li>重置连接：很多APP里都有停止下载图片的需求，对于http1.x来说，是直接断开连接，导致下次再发请求必须重新建立连接；http2.0引入RST_STREAM类型的frame，可以在不断开连接的前提下取消某个request的stream</li></ul> <p>其中涉及了两个新的概念：</p> <ul><li><strong>数据流-stream</strong>：基于TCP连接之上的逻辑双向字节流，用于承载双向消息，对应一个请求及其响应。客户端每发起一个请求就建立一个数据流，后续该请求及其响应的所有数据都通过该数据流传输。每个数据流都有一个唯一的标识符和可选的优先级信息。</li> <li><strong>帧-frame</strong>：HTTP/2的最小数据切片单位，承载着特定类型的数据，例如 HTTP 标头、消息负载，等等。 来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装，从而在宏观上实现了多个请求或响应并行传输的效果。</li></ul> <p><img src="https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612175341.png" alt="003"></p> <center>图为http2.0</center> <p>这里的 <strong>多路复用机制 就实现了 在同一个TCP连接上 多个请求 并行执行。</strong></p> <p>无论是HTTP1.1的Keep-Alive机制还是HTTP2.0的多路复用机制，在实现上都需要引入<strong>连接池</strong>来维护网络连接。下面就开始分析 <strong>OkHttp中的连接池实现</strong>——连接拦截器<strong>ConnectInterceptor</strong>。</p> <h2 id="connectinterceptor"><a href="#connectinterceptor" class="header-anchor">#</a> ConnectInterceptor</h2> <p>连接拦截器ConnectInterceptor代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//打开到目标服务的连接、处理下一个拦截器</span>
<span class="token keyword">public</span> final <span class="token keyword">class</span> <span class="token class-name">ConnectInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> final OkHttpClient client<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">ConnectInterceptor</span><span class="token punctuation">(</span><span class="token parameter">OkHttpClient client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @Override <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    RealInterceptorChain realChain <span class="token operator">=</span> <span class="token punctuation">(</span>RealInterceptorChain<span class="token punctuation">)</span> chain<span class="token punctuation">;</span>
    Request request <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Transmitter transmitter <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">transmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span>
    boolean doExtensiveHealthChecks <span class="token operator">=</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Exchange exchange <span class="token operator">=</span> transmitter<span class="token punctuation">.</span><span class="token function">newExchange</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> realChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> transmitter<span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>代码很少，主要是使用transmitter.newExchange获取Exchange实例，并作为参数调用拦截器链的proceed的方法。注意到前面分析过的拦截器调用的proceed方法是一个参数的，而这里是三个参数的。这是因为下一个拦截器（如果没有配置网络拦截器的话，就是CallServerInterceptor，也是最后一个）需要进行真正的网络IO操作，而 <strong>Exchange（意为交换）主要作用就是真正的IO操作：写入请求、读取响应</strong>（会在下一个拦截器做介绍）。</p> <p>实际上获取Exchange实例的逻辑处理都封装在Transmitter中了。前面的文章提到过Transmitter，它是“发射器”，是把 请求 从应用端 发射到 网络层，它持有请求的 连接、请求、响应 和 流，一个请求对应一个Transmitter实例，一个数据流。下面就看下它的newExchange方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  Exchange <span class="token function">newExchange</span><span class="token punctuation">(</span><span class="token parameter">Interceptor<span class="token punctuation">.</span>Chain chain<span class="token punctuation">,</span> boolean doExtensiveHealthChecks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">connectionPool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>noMoreExchanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;released&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exchange <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;cannot make a new request because the previous response &quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;is still open: please call response.close()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    ExchangeCodec codec <span class="token operator">=</span> exchangeFinder<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Exchange result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> exchangeFinder<span class="token punctuation">,</span> codec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">connectionPool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>exchange <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>exchangeRequestDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>exchangeResponseDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>若是第一次请求，前面两个if是没走进去的。接着看到使用exchangeFinder的find方法获取到了ExchangeCodec实例，然后作为参数构建了Exchange实例，并返回。嗯，看起来也很简单的样子。 注意到这个方法里涉及了连接池RealConnectionPool、交换寻找器ExchangeFinder、交换编解码ExchangeCodec、交换管理Exchange这几个类（翻译成这样尽力了?，意会吧）。</p> <ul><li>RealConnectionPool，连接池，负责管理请求的连接，包括新建、复用、关闭，理解上类似线程池。</li> <li>ExchangeCodec，接口类，负责真正的IO操作—写请求、读响应，实现类有Http1ExchangeCodec、Http2ExchangeCodec，分别对应HTTP1.1协议、HTTP2.0协议。</li> <li>Exchange，管理IO操作，可以理解为 数据流，是ExchangeCodec的包装，增加了事件回调；一个请求对应一个Exchange实例。传给下个拦截器CallServerInterceptor使用。</li> <li>ExchangeFinder，（从连接池中）寻找可用TCP连接，然后通过连接得到ExchangeCodec。</li></ul> <h3 id="exchangefinder"><a href="#exchangefinder" class="header-anchor">#</a> ExchangeFinder</h3> <p>ExchangeFinder的作用从名字就可以看出——Exchange寻找者，本质是为请求寻找一个TCP连接。如果已有可用连接就直接使用，没有则打开一个新的连接。 一个网络请求的执行，需要先有一个指向目标服务的TCP连接，然后再进行写请求、读响应的IO操作。ExchangeFinder是怎么寻找的呢？继续往下看~</p> <p>我们先看exchangeFinder初始化的地方：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepareToConnect</span><span class="token punctuation">(</span><span class="token parameter">Request request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>exchangeFinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExchangeFinder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> connectionPool<span class="token punctuation">,</span> <span class="token function">createAddress</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>看到这里应该会想起上一篇文章中分析RetryAndFollowUpInterceptor时提到过，prepareToConnect这个方法作用是连接准备，就是创建了ExchangeFinder实例。主要到传入的参数有connectionPool、createAddress方法返回的Address、call、eventListener。connectionPool是连接池，稍后分析，先看下createAddress方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">private</span> Address <span class="token function">createAddress</span><span class="token punctuation">(</span><span class="token parameter">HttpUrl url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SSLSocketFactory sslSocketFactory <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    HostnameVerifier hostnameVerifier <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    CertificatePinner certificatePinner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">isHttps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sslSocketFactory <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hostnameVerifier <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">hostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      certificatePinner <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">certificatePinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">dns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">socketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sslSocketFactory<span class="token punctuation">,</span> hostnameVerifier<span class="token punctuation">,</span> certificatePinner<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">proxyAuthenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        client<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">protocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">connectionSpecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">proxySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>使用url和client配置 创建一个Address实例。Address意思是指向服务的连接的地址，可以理解为请求地址及其配置。Address有一个重要作用：<strong>相同Address的HTTP请求 共享 相同的连接</strong>。这可以作为前面提到的 HTTP1.1和HTTP2.0 <strong>复用连接</strong> 的请求的判断。</p> <p>回头看exchangeFinder的find方法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">public</span> ExchangeCodec <span class="token function">find</span><span class="token punctuation">(</span>
      <span class="token parameter">OkHttpClient client<span class="token punctuation">,</span> Interceptor<span class="token punctuation">.</span>Chain chain<span class="token punctuation">,</span> boolean doExtensiveHealthChecks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    int connectTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">connectTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    int readTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    int writeTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">writeTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    int pingIntervalMillis <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">pingIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolean connectionRetryEnabled <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">retryOnConnectionFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//找到一个健康的连接</span>
      RealConnection resultConnection <span class="token operator">=</span> <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span>
          writeTimeout<span class="token punctuation">,</span> pingIntervalMillis<span class="token punctuation">,</span> connectionRetryEnabled<span class="token punctuation">,</span> doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//利用连接实例化ExchangeCodec对象，如果是HTTP/2返回Http2ExchangeCodec，否则返回Http1ExchangeCodec</span>
      <span class="token keyword">return</span> resultConnection<span class="token punctuation">.</span><span class="token function">newCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>RouteException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trackFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>主要就是通过findHealthyConnection方法获取连接RealConnection实例，然后用RealConnection的newCodec方法获取了ExchangeCodec实例，如果是HTTP/2返回Http2ExchangeCodec，否则返回Http1ExchangeCodec，然后返回。</p> <p>findHealthyConnection方法名透露着 就是去寻找可用TCP连接的，而我们猜测这个方法内部肯定和连接池ConnectionPool有紧密的关系。接着跟进findHealthyConnection方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">private</span> RealConnection <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>int connectTimeout<span class="token punctuation">,</span> int readTimeout<span class="token punctuation">,</span>
      int writeTimeout<span class="token punctuation">,</span> int pingIntervalMillis<span class="token punctuation">,</span> boolean connectionRetryEnabled<span class="token punctuation">,</span>
      boolean doExtensiveHealthChecks<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//找连接</span>
      RealConnection candidate <span class="token operator">=</span> <span class="token function">findConnection</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span>
          pingIntervalMillis<span class="token punctuation">,</span> connectionRetryEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 是新连接 且不是HTTP2.0 就不用体检</span>
      <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">connectionPool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span>successCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>candidate<span class="token punctuation">.</span><span class="token function">isMultiplexed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> candidate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 体检不健康，继续找</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidate<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span>doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//标记不可用</span>
        candidate<span class="token punctuation">.</span><span class="token function">noNewExchanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> candidate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>循环寻找连接：如果是不健康的连接，标记不可用（标记后会移除，后面讲连接池会讲到），然后继续找。健康是指连接可以承载新的数据流，socket是连接状态。我们跟进findConnection方法，看看到底是怎么 <strong>找连接</strong> 的：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//为承载新的数据流 寻找 连接。寻找顺序是 已分配的连接、连接池、新建连接</span>
  <span class="token keyword">private</span> RealConnection <span class="token function">findConnection</span><span class="token punctuation">(</span>int connectTimeout<span class="token punctuation">,</span> int readTimeout<span class="token punctuation">,</span> int writeTimeout<span class="token punctuation">,</span>
      int pingIntervalMillis<span class="token punctuation">,</span> boolean connectionRetryEnabled<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    boolean foundPooledConnection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    RealConnection result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    Route selectedRoute <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    RealConnection releasedConnection<span class="token punctuation">;</span>
    Socket toClose<span class="token punctuation">;</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">connectionPool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//请求已被取消（Call的cancel方法-&gt;transmitter的cancel方法），抛异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>transmitter<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Canceled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hasStreamFailure <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 

      <span class="token comment">// 尝试使用 已给数据流分配的连接.（例如重定向请求时，可以复用上次请求的连接）</span>
      releasedConnection <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
      <span class="token comment">//有已分配的连接，但已经被限制承载新的数据流，就尝试释放掉（如果连接上已没有数据流），并返回待关闭的socket。</span>
      toClose <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>noNewExchanges
          <span class="token operator">?</span> transmitter<span class="token punctuation">.</span><span class="token function">releaseConnectionNoEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>transmitter<span class="token punctuation">.</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不为空，说明上面没有释放掉，那么此连接可用</span>
        result <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
        releasedConnection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有已分配的可用连接，就尝试从连接池获取。（连接池稍后详细讲解）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">transmitterAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> transmitter<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          foundPooledConnection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          result <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nextRouteToTry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          selectedRoute <span class="token operator">=</span> nextRouteToTry<span class="token punctuation">;</span><span class="token comment">//有可尝试的路由</span>
          nextRouteToTry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">retryCurrentRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          selectedRoute <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>toClose<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//（如果有）关闭待关闭的socket</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>releasedConnection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionReleased</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> releasedConnection<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//（如果有）回调连接释放事件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>foundPooledConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(如果有）回调（从连接池）获取连接事件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果有已分配可用连接 或 从连接池获取到连接，结束！  没有 就走下面的新建连接过程。</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果需要路由信息，就获取。是阻塞操作</span>
    boolean newRouteSelection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedRoute <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>routeSelection <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>routeSelection<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newRouteSelection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      routeSelection <span class="token operator">=</span> routeSelector<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    List<span class="token operator">&lt;</span>Route<span class="token operator">&gt;</span> routes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">connectionPool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>transmitter<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Canceled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>newRouteSelection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//现在有了IP地址，再次尝试从连接池获取。可能会因为连接合并而匹配。（这里传入了routes，上面的传的null）</span>
        routes <span class="token operator">=</span> routeSelection<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">transmitterAcquirePooledConnection</span><span class="token punctuation">(</span>
            address<span class="token punctuation">,</span> transmitter<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          foundPooledConnection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          result <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//第二次连接池也没找到，就新建连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundPooledConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedRoute <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          selectedRoute <span class="token operator">=</span> routeSelection<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Create a connection and assign it to this allocation immediately. This makes it possible</span>
        <span class="token comment">// for an asynchronous cancel() to interrupt the handshake we're about to do.</span>
        result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealConnection</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> selectedRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectingConnection <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果第二次从连接池的尝试成功了，结束，因为连接池中的连接是已经和服务器建立连接的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>foundPooledConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 第二次没成功，就把新建的连接，进行TCP + TLS 握手，与服务端建立连接. 是阻塞操作</span>
    result<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span> pingIntervalMillis<span class="token punctuation">,</span>
        connectionRetryEnabled<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    connectionPool<span class="token punctuation">.</span>routeDatabase<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从失败名单中移除</span>

    Socket socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">connectionPool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      connectingConnection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 最后一次尝试从连接池获取，注意最后一个参数为true，即要求 多路复用（http2.0）</span>
      <span class="token comment">//意思是，如果本次是http2.0，那么为了保证 多路复用性，（因为上面的握手操作不是线程安全）会再次确认连接池中此时是否已有同样连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">transmitterAcquirePooledConnection</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> transmitter<span class="token punctuation">,</span> routes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果获取到，就关闭我们创建里的连接，返回获取的连接</span>
        result<span class="token punctuation">.</span>noNewExchanges <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        socket <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> transmitter<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>

        <span class="token comment">// 那么这个刚刚连接成功的路由 就可以 用作下次 尝试的路由</span>
        nextRouteToTry <span class="token operator">=</span> selectedRoute<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//最后一次尝试也没有的话，就把刚刚新建的连接存入连接池</span>
        connectionPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transmitter<span class="token punctuation">.</span><span class="token function">acquireConnectionNoEvents</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把连接赋给transmitter</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果刚刚建立的连接没用到，就关闭</span>

    eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><p>代码看着很长，已经加了注释，方法目的就是 为 承载新的数据流 寻找 连接。寻找顺序是 已分配的连接、连接池、新建连接。梳理如下：</p> <ol><li>首先会尝试使用 已给数据流分配的连接。（已分配连接的情况例如重定向时的再次请求，说明上次已经有了连接）</li> <li>若没有 已分配的可用连接，就尝试从连接池中 匹配获取。因为此时没有路由信息，所以匹配条件：address一致——host、port、代理等一致，且 匹配的连接可以接受新的数据流。</li> <li>若从连接池没有获取到，则取下一个代理的路由信息（多个Route，即多个IP地址），再次尝试从连接池获取，此时可能因为连接合并而匹配到。</li> <li>若第二次也没有获取到，就创建RealConnection实例，进行TCP + TLS 握手，与服务端建立连接。</li> <li>此时为了确保Http2.0连接的多路复用性，会第三次从连接池匹配。因为新建立的连接的握手过程是非线程安全的，所以此时可能连接池新存入了相同的连接。</li> <li>第三次若匹配到，就使用已有连接，释放刚刚新建的连接；若未匹配到，则把新连接存入连接池并返回。</li></ol> <p><strong>流程图</strong>如下：</p> <p><img src="https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612175506.png" alt="004"></p> <center>findConnection方法流程</center> <p><strong>看到这里，小盆友，你是否有很多问号？</strong></p> <ul><li>开始若有了已分配的连接，但已经被限制承载新的数据流，是如何释放的呢？</li> <li>代理路由信息是如何获取的呢？</li> <li>如何从连接池获取连接的？三次有什么不同？</li></ul> <p>没关系，慢慢来，我们先看第二个问号，代理路由信息的获取。</p> <h3 id="routeselector"><a href="#routeselector" class="header-anchor">#</a> RouteSelector</h3> <p>先来看下Route类：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">public</span> final <span class="token keyword">class</span> <span class="token class-name">Route</span> <span class="token punctuation">{</span>
  final Address address<span class="token punctuation">;</span>
  final Proxy proxy<span class="token punctuation">;</span><span class="token comment">//代理</span>
  final InetSocketAddress inetSocketAddress<span class="token punctuation">;</span><span class="token comment">//连接目标地址</span>

  <span class="token keyword">public</span> <span class="token function">Route</span><span class="token punctuation">(</span><span class="token parameter">Address address<span class="token punctuation">,</span> Proxy proxy<span class="token punctuation">,</span> InetSocketAddress inetSocketAddress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inetSocketAddress <span class="token operator">=</span> inetSocketAddress<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Route，通过代理服务器信息 proxy、连接目标地址 InetSocketAddress 来描述一条 连接服务器的具体路由</strong>。</p> <ul><li>proxy代理：可以为客户端显式配置代理服务器。否则，将使用ProxySelector代理选择器。可能会返回多个代理。</li> <li>IP地址：无论是直连还是代理，打开socket连接都需要IP地址。 DNS服务可能返回多个IP地址尝试。</li></ul> <p>上面分析的findConnection方法中是使用routeSelection.getAll()获取Route集合routes，而routeSelection是通过routeSelector.next()获取，routeSelector是在ExchangeFinder的构造方法内创建的，也就是说routeSelector在RetryAndFollowUpInterceptor中就创建了，那么我们看下RouteSelector：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token function">RouteSelector</span><span class="token punctuation">(</span><span class="token parameter">Address address<span class="token punctuation">,</span> RouteDatabase routeDatabase<span class="token punctuation">,</span> Call call<span class="token punctuation">,</span>
      EventListener eventListener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routeDatabase <span class="token operator">=</span> routeDatabase<span class="token punctuation">;</span><span class="token comment">//连接池中的路由黑名单（连接失败的路由）</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> call<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventListener <span class="token operator">=</span> eventListener<span class="token punctuation">;</span>

    <span class="token function">resetNextProxy</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//收集代理服务器</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetNextProxy</span><span class="token punctuation">(</span><span class="token parameter">HttpUrl url<span class="token punctuation">,</span> Proxy proxy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若指定了代理，那么就这一个。（就是初始化OkhttpClient时配置的）</span>
      proxies <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//没配置就使用ProxySelector获取代理（若初始化OkhttpClient时没有配置ProxySelector，会使用系统默认的） </span>
      List<span class="token operator">&lt;</span>Proxy<span class="token operator">&gt;</span> proxiesOrNull <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">proxySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      proxies <span class="token operator">=</span> proxiesOrNull <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>proxiesOrNull<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">?</span> Util<span class="token punctuation">.</span><span class="token function">immutableList</span><span class="token punctuation">(</span>proxiesOrNull<span class="token punctuation">)</span>
          <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">immutableList</span><span class="token punctuation">(</span>Proxy<span class="token punctuation">.</span><span class="token constant">NO_PROXY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextProxyIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>注意到RouteSelector的构造方法中传入了routeDatabase，是连接失败的路由黑名单（后面连接池也会讲到），并使用resetNextProxy方法获取代理服务器列表：若没有指定proxy就是用ProxySelector获取proxy列表（若没有配置ProxySelector会使用系统默认）。接着看next方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//收集代理的路由信息</span>
  <span class="token keyword">public</span> Selection <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//还有下一个代理</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    List<span class="token operator">&lt;</span>Route<span class="token operator">&gt;</span> routes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">hasNextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Proxy proxy <span class="token operator">=</span> <span class="token function">nextProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//遍历proxy经DNS后的所有IP地址，组装成Route</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> inetSocketAddresses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Route route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Route</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> inetSocketAddresses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>routeDatabase<span class="token punctuation">.</span><span class="token function">shouldPostpone</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//此路由在黑名单中，存起来最后尝试</span>
          postponedRoutes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>routes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若没有拿到路由，就尝试上面存的黑名单的路由</span>
      routes<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>postponedRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      postponedRoutes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//routes包装成Selection返回</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Selection</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>next方法主要就是获取下一个代理Proxy的代理信息，即多个路由。具体是在resetNextInetSocketAddress方法中实现，主要是对代理服务地址进行DNS解析获取多个IP地址，这里就不展开了。</p> <p>好了，到这里 就解决了第二个问号。其他两个问号涉及 连接池RealConnectionPool、连接RealConnection，下面就来瞅瞅。</p> <h2 id="connectionpool"><a href="#connectionpool" class="header-anchor">#</a> <strong>ConnectionPool</strong></h2> <p>ConnectionPool，即连接池，用于管理http1.1/http2.0连接重用，以减少网络延迟。相同Address的http请求可以共享一个连接，ConnectionPool就是实现了连接的复用。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">public</span> final <span class="token keyword">class</span> <span class="token class-name">ConnectionPool</span> <span class="token punctuation">{</span>
  final RealConnectionPool delegate<span class="token punctuation">;</span>
  <span class="token comment">//最大空闲连接数5，最大空闲时间5分钟</span>
  <span class="token keyword">public</span> <span class="token function">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">ConnectionPool</span><span class="token punctuation">(</span><span class="token parameter">int maxIdleConnections<span class="token punctuation">,</span> long keepAliveDuration<span class="token punctuation">,</span> TimeUnit timeUnit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealConnectionPool</span><span class="token punctuation">(</span>maxIdleConnections<span class="token punctuation">,</span> keepAliveDuration<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//返回空闲连接数</span>
  <span class="token keyword">public</span> int <span class="token function">idleConnectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">idleConnectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//返回池子中的连接数</span>
  <span class="token keyword">public</span> int <span class="token function">connectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">connectionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//关闭并移除所以空闲连接</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">evictAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    delegate<span class="token punctuation">.</span><span class="token function">evictAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>ConnectionPool看起来比较好理解，默认配置是最大空闲连接数5，最大空闲时间5分钟（即一个连接空闲时间超过5分钟就移除），我们也可以在初始化okhttpClient时进行不同的配置。需要注意的是ConnectionPool是用于应用层，实际管理者是RealConnectionPool。RealConnectionPool是okhttp内部真实管理连接的地方。</p> <p>连接池对连接的管理无非是 存、取、删，上面的两个问号分别对应 删、取，跟进RealConnectionPool我们一个个看：</p> <h4 id="存"><a href="#存" class="header-anchor">#</a> <strong>存</strong></h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">private</span> final Deque<span class="token operator">&lt;</span>RealConnection<span class="token operator">&gt;</span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> final Runnable cleanupRunnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//循环清理</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//清理</span>
      long waitNanos <span class="token operator">=</span> <span class="token function">cleanup</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>waitNanos <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>waitNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        long waitMillis <span class="token operator">=</span> waitNanos <span class="token operator">/</span> 1000000L<span class="token punctuation">;</span>
        waitNanos <span class="token operator">-=</span> <span class="token punctuation">(</span>waitMillis <span class="token operator">*</span> 1000000L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter">RealConnectionPool<span class="token punctuation">.</span>this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//下一次清理之前的等待</span>
            RealConnectionPool<span class="token punctuation">.</span>this<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>waitMillis<span class="token punctuation">,</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> waitNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>InterruptedException ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//存</span>
  <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token parameter">RealConnection connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cleanupRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cleanupRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>cleanupRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>connections是用于存连接的队列Deque。看到在add之前 使用线程池executor执行了cleanupRunnable，意思是清理连接，为啥要清理呢？上面提到过 连接池有 最大空闲连接数、最大空闲时间的限制，所以不满足时是要进行清理的。并且注意到清理是一个循环，并且下一次清理前要等待waitNanos时间，啥意思呢？我们看下cleanup方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  long <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token parameter">long now</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    int inUseConnectionCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//正在使用的连接数</span>
    int idleConnectionCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//空闲连接数</span>
    RealConnection longestIdleConnection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//空闲时间最长的连接</span>
    long longestIdleDurationNs <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span><span class="token comment">//最长的空闲时间</span>

    <span class="token comment">//遍历连接：找到待清理的连接, 找到下一次要清理的时间（还未到最大空闲时间）</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>RealConnection<span class="token operator">&gt;</span> i <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RealConnection connection <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//若连接正在使用，continue，正在使用连接数+1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pruneAndGetAllocationCount</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          inUseConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//空闲连接数+1</span>
        idleConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">// 赋值最长的空闲时间和对应连接</span>
        long idleDurationNs <span class="token operator">=</span> now <span class="token operator">-</span> connection<span class="token punctuation">.</span>idleAtNanos<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idleDurationNs <span class="token operator">&gt;</span> longestIdleDurationNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          longestIdleDurationNs <span class="token operator">=</span> idleDurationNs<span class="token punctuation">;</span>
          longestIdleConnection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//若最长的空闲时间大于5分钟 或 空闲数 大于5，就移除并关闭这个连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>longestIdleDurationNs <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveDurationNs
          <span class="token operator">||</span> idleConnectionCount <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxIdleConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>longestIdleConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idleConnectionCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// else，就返回 还剩多久到达5分钟，然后wait这个时间再来清理</span>
        <span class="token keyword">return</span> keepAliveDurationNs <span class="token operator">-</span> longestIdleDurationNs<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inUseConnectionCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//连接没有空闲的，就5分钟后再尝试清理.</span>
        <span class="token keyword">return</span> keepAliveDurationNs<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有连接，不清理</span>
        cleanupRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关闭移除的连接</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>longestIdleConnection<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//关闭移除后 立刻 进行下一次的 尝试清理</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>思路还是很清晰的：</p> <ul><li>有空闲连接的话，如果最长的空闲时间大于5分钟 或 空闲数 大于5，就移除关闭这个最长空闲连接；如果 空闲数 不大于5 且 最长的空闲时间不大于5分钟，就返回到5分钟的剩余时间，然后等待这个时间再来清理。</li> <li>没有空闲连接就等5分钟后再尝试清理。</li> <li>没有连接不清理。</li></ul> <p>其中判断连接正在使用的方法pruneAndGetAllocationCount我们来看下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">private</span> int <span class="token function">pruneAndGetAllocationCount</span><span class="token punctuation">(</span><span class="token parameter">RealConnection connection<span class="token punctuation">,</span> long now</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接上的数据流，弱引用列表</span>
    List<span class="token operator">&lt;</span>Reference<span class="token operator">&lt;</span>Transmitter<span class="token operator">&gt;&gt;</span> references <span class="token operator">=</span> connection<span class="token punctuation">.</span>transmitters<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> references<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Reference<span class="token operator">&lt;</span>Transmitter<span class="token operator">&gt;</span> reference <span class="token operator">=</span> references<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 到这里，transmitter是泄漏的，要移除，且此连接不能再承载新的数据流（泄漏的原因就是下面的message）</span>
      TransmitterReference transmitterRef <span class="token operator">=</span> <span class="token punctuation">(</span>TransmitterReference<span class="token punctuation">)</span> reference<span class="token punctuation">;</span>
      String message <span class="token operator">=</span> <span class="token string">&quot;A connection to &quot;</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">&quot; was leaked. Did you forget to close a response body?&quot;</span><span class="token punctuation">;</span>
      Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logCloseableLeak</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> transmitterRef<span class="token punctuation">.</span>callStackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
      references<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      connection<span class="token punctuation">.</span>noNewExchanges <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token comment">//连接因为泄漏没有数据流了，那么可以立即移除了。所以设置 开始空闲时间 是5分钟前（厉害厉害！）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>references<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span>idleAtNanos <span class="token operator">=</span> now <span class="token operator">-</span> keepAliveDurationNs<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回连接上的数据流数量，大于0说明正在使用。</span>
    <span class="token keyword">return</span> references<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>逻辑注释已经标明了，很好理解。其中connection.transmitters，表示在此连接上的数据流，transmitters size大于1即表示多个请求复用此连接。</p> <p>另外，在findConnection中，使用connectionPool.put(result)存连接后，又调用transmitter.acquireConnectionNoEvents方法，瞅下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">void</span> <span class="token function">acquireConnectionNoEvents</span><span class="token punctuation">(</span><span class="token parameter">RealConnection connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span>transmitters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransmitterReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> callStackTrace<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>先把连接赋给transmitter，表示数据流transmitter依附在这个connection上；然后connection.transmitters add 这个transmitter的弱引用，connection.transmitters表示这个连接承载的所有数据流，即承载的所有请求。</p> <p>好了，存 讲完了，主要就是把连接存入队列，同时开始循环尝试清理过期连接。</p> <h4 id="取"><a href="#取" class="header-anchor">#</a> <strong>取</strong></h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//为transmitter 从连接池 获取 对应address的连接。若果routes不为空，可能会因为 连接合并（复用） 而获取到HTTP/2连接。</span>
  boolean <span class="token function">transmitterAcquirePooledConnection</span><span class="token punctuation">(</span><span class="token parameter">Address address<span class="token punctuation">,</span> Transmitter transmitter<span class="token punctuation">,</span>
      @Nullable List<span class="token operator">&lt;</span>Route<span class="token operator">&gt;</span> routes<span class="token punctuation">,</span> boolean requireMultiplexed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>RealConnection connection <span class="token operator">:</span> connections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>requireMultiplexed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isMultiplexed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isEligible</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> routes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
      transmitter<span class="token punctuation">.</span><span class="token function">acquireConnectionNoEvents</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>存的方法名是put，但你发现 取 的方法名却不是get，transmitterAcquirePooledConnection意思是 为transmitter 从连接池 获取连接，实际上transmitter就代表一个数据流，也就是一个http请求。注意到，在遍历中 经过判断后也是transmitter的acquireConnectionNoEvents方法，即把匹配到的connection赋给transmitter。所以方法名还是很生动的。</p> <p>继续看是如何匹配的：如果requireMultiplexed为false，即不是多路复用（不是http/2），那么就要看Connection的isEligible方法了，isEligible方法返回true，就代表匹配成功：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//用于判断 连接 是否 可以承载指向address的数据流</span>
  boolean <span class="token function">isEligible</span><span class="token punctuation">(</span><span class="token parameter">Address address<span class="token punctuation">,</span> @Nullable List<span class="token operator">&lt;</span>Route<span class="token operator">&gt;</span> routes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接不再接受新的数据流，false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transmitters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> allocationLimit <span class="token operator">||</span> noNewExchanges<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">//匹配address中非host的部分</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Internal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">equalsNonHost</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">//匹配address的host，到这里也匹配的话，就return true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// This connection is a perfect match.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//到这里hostname是没匹配的，但是还是有机会返回true：连接合并</span>
    <span class="token comment">// 1. 连接须是 HTTP/2.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. IP 地址匹配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>routes <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">routeMatchesAny</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 证书匹配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">hostnameVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> OkHostnameVerifier<span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">supportsUrl</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 证书 pinning 匹配.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      address<span class="token punctuation">.</span><span class="token function">certificatePinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">peerCertificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>SSLPeerUnverifiedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// The caller's address can be carried by this connection.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> boolean <span class="token function">routeMatchesAny</span><span class="token punctuation">(</span><span class="token parameter">List<span class="token operator">&lt;</span>Route<span class="token operator">&gt;</span> candidates</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Route candidate <span class="token operator">=</span> candidates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token constant">DIRECT</span>
          <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token constant">DIRECT</span>
          <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>取的过程就是 遍历连接池，进行地址等一系列匹配，到这里第三个问号也解决了。</p> <h4 id="删"><a href="#删" class="header-anchor">#</a> <strong>删</strong></h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//移除关闭空闲连接</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">evictAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>RealConnection<span class="token operator">&gt;</span> evictedConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>RealConnection<span class="token operator">&gt;</span> i <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RealConnection connection <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span>transmitters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          connection<span class="token punctuation">.</span>noNewExchanges <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          evictedConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
          i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>RealConnection connection <span class="token operator">:</span> evictedConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeQuietly</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>遍历连接池，如果连接上的数据流是空，那么就从连接池移除并且关闭。</p> <p>我们回过头看下Transmitter的releaseConnectionNoEvents方法，也就第一个问号，如果连接不再接受新的数据流，就会调用这个方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//从连接上移除transmitter.</span>
  @Nullable Socket <span class="token function">releaseConnectionNoEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    int index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历 此数据流依附的连接 上的所有数据流，找到index</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span>transmitters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Reference<span class="token operator">&lt;</span>Transmitter<span class="token operator">&gt;</span> reference <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span>transmitters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//transmitters移除此数据流</span>
    RealConnection released <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
    released<span class="token punctuation">.</span>transmitters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//如果连接上没有有数据流了，就置为空闲（等待清理），并返回待关闭的socket</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>released<span class="token punctuation">.</span>transmitters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      released<span class="token punctuation">.</span>idleAtNanos <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">.</span><span class="token function">connectionBecameIdle</span><span class="token punctuation">(</span>released<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> released<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>主要就是尝试释放连接，连接上没有数据流就关闭socket等待被清理。</p> <p>好了，到这里连接池的管理就分析完了。</p> <p>从连接的查找 到 连接池的管理，就是ConnectInterceptor的内容了。</p> <h2 id="callserverinterceptor"><a href="#callserverinterceptor" class="header-anchor">#</a> CallServerInterceptor</h2> <p>哎呀，终于到最后一个拦截器了！</p> <p>请求服务拦截器，也就是真正地去进行网络IO读写了——写入http请求的header和body数据、读取响应的header和body。</p> <p>上面ConnectInterceptor主要介绍了如何 寻找连接 以及 连接池如何管理连接。在获取到连接后，调用了RealConnection的newCodec方法ExchangeCodec实例，然后使用ExchangeCodec实例创建了Exchange实例传入CallServerInterceptor了。上面提到过ExchangeCodec负责请求和响应的IO读写，我们先来看看<strong>ExchangeCodec创建过程</strong>——RealConnection的newCodec方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  ExchangeCodec <span class="token function">newCodec</span><span class="token punctuation">(</span>OkHttpClient client<span class="token punctuation">,</span> Interceptor<span class="token punctuation">.</span>Chain chain<span class="token punctuation">)</span> throws SocketException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Http2ExchangeCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> chain<span class="token punctuation">,</span> http2Connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      source<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sink<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">writeTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Http1ExchangeCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>http2Connection不为空就创建Http2ExchangeCodec，否则是Http1ExchangeCodec。而http2Connection的创建是连接进行TCP、TLS握手的时候，即在RealConnection的connect方法中，具体就是connect方法中调用的establishProtocol方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">establishProtocol</span><span class="token punctuation">(</span>ConnectionSpecSelector connectionSpecSelector<span class="token punctuation">,</span>
      int pingIntervalMillis<span class="token punctuation">,</span> Call call<span class="token punctuation">,</span> EventListener eventListener<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    <span class="token comment">//针对http请求，如果配置的协议包含Protocol.H2_PRIOR_KNOWLEDGE，则开启Http2连接</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">protocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Protocol<span class="token punctuation">.</span><span class="token constant">H2_PRIOR_KNOWLEDGE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socket <span class="token operator">=</span> rawSocket<span class="token punctuation">;</span>
        protocol <span class="token operator">=</span> Protocol<span class="token punctuation">.</span><span class="token constant">H2_PRIOR_KNOWLEDGE</span><span class="token punctuation">;</span>
        <span class="token function">startHttp2</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      socket <span class="token operator">=</span> rawSocket<span class="token punctuation">;</span>
      protocol <span class="token operator">=</span> Protocol<span class="token punctuation">.</span><span class="token constant">HTTP_1_1</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//针对https请求，会在TLS握手后，根据平台获取协议（），如果协议是Protocol.HTTP_2，则开启Http2连接</span>
    eventListener<span class="token punctuation">.</span><span class="token function">secureConnectStart</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connectTls</span><span class="token punctuation">(</span>connectionSpecSelector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventListener<span class="token punctuation">.</span><span class="token function">secureConnectEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> handshake<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">==</span> Protocol<span class="token punctuation">.</span><span class="token constant">HTTP_2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">startHttp2</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startHttp2</span><span class="token punctuation">(</span>int pingIntervalMillis<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// HTTP/2 connection timeouts are set per-stream.</span>
    http2Connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Http2Connection<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">pingIntervalMillis</span><span class="token punctuation">(</span>pingIntervalMillis<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http2Connection<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>好了，到这里不再深入了，继续了解可以参考HTTP 2.0与OkHttp。那么到这里，ExchangeCodec已经创建了，然后又包装成Exchange，最后传入了CallServerInterceptor。</p> <p>下面就来看看这最后一个拦截器：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">public</span> final <span class="token keyword">class</span> <span class="token class-name">CallServerInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> final boolean forWebSocket<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">CallServerInterceptor</span><span class="token punctuation">(</span><span class="token parameter">boolean forWebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>forWebSocket <span class="token operator">=</span> forWebSocket<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @Override <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
    RealInterceptorChain realChain <span class="token operator">=</span> <span class="token punctuation">(</span>RealInterceptorChain<span class="token punctuation">)</span> chain<span class="token punctuation">;</span>
    Exchange exchange <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上个拦截器传入的exchange</span>
    Request request <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    long sentRequestMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//写请求头</span>
    exchange<span class="token punctuation">.</span><span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    boolean responseHeadersStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    Response<span class="token punctuation">.</span>Builder responseBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//含body的请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">permitsRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 若请求头包含 &quot;Expect: 100-continue&quot; , 就会等服务端返回含有 &quot;HTTP/1.1 100 Continue&quot;的响应，然后再发送请求body. </span>
      <span class="token comment">//如果没有收到这个响应（例如收到的响应是4xx），那就不发送body了。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;100-continue&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Expect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exchange<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseHeadersStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//responseBuilder为null说明服务端返回了100，也就是可以继续发送body了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//默认是false不会进入</span>
          <span class="token comment">// Prepare a duplex body so that the application can send a request body later.</span>
          exchange<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          BufferedSink bufferedRequestBody <span class="token operator">=</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>
              exchange<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 满足了 &quot;Expect: 100-continue&quot; ，写请求body</span>
          BufferedSink bufferedRequestBody <span class="token operator">=</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>
              exchange<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
          bufferedRequestBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token comment">//没有满足 &quot;Expect: 100-continue&quot; ，请求发送结束</span>
        exchange<span class="token punctuation">.</span><span class="token function">noRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exchange<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMultiplexed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If the &quot;Expect: 100-continue&quot; expectation wasn't met, prevent the HTTP/1 connection</span>
          <span class="token comment">// from being reused. Otherwise we're still obligated to transmit the request body to</span>
          <span class="token comment">// leave the connection in a consistent state.</span>
          exchange<span class="token punctuation">.</span><span class="token function">noNewExchangesOnConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token comment">//没有body，请求发送结束</span>
      exchange<span class="token punctuation">.</span><span class="token function">noRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//请求发送结束</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDuplex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exchange<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//回调 读响应头开始事件（如果上面没有）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>responseHeadersStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exchange<span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//读响应头（如果上面没有）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      responseBuilder <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//构建response</span>
    Response response <span class="token operator">=</span> responseBuilder
        <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    int code <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//这里服务端又返回了个100，就再尝试获取真正的响应（）</span>
      response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      code <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//回调读响应头结束</span>
    exchange<span class="token punctuation">.</span><span class="token function">responseHeadersEnd</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这里就是获取响应body了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>forWebSocket <span class="token operator">&amp;&amp;</span> code <span class="token operator">==</span> <span class="token number">101</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Connection is upgrading, but we need to ensure interceptors see a non-null response body.</span>
      response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token constant">EMPTY_RESPONSE</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">openResponseBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//请求头中Connection是close，表示请求完成后要关闭连接</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exchange<span class="token punctuation">.</span><span class="token function">noNewExchangesOnConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//204（无内容）、205（充值内容），body应该是空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">204</span> <span class="token operator">||</span> code <span class="token operator">==</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span>
          <span class="token string">&quot;HTTP &quot;</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">&quot; had non-zero Content-Length: &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><p>你会发现，整个内容就是前面说的一句话：写入http请求的header和body、读取响应的header和body。这里就不再解释了。</p> <p>这里我们可以看到，无论写请求还是读响应，都是使用Exchange对应的方法。上面也提到过Exchange理解上是对ExchangeCodec的包装，这写方法内部除了事件回调和一些参数获取外，核心工作都由 ExchangeCodec 对象完成，而 ExchangeCodec实际上利用的是 Okio，而 Okio 实际上还是用的 Socket。</p> <p>ExchangeCodec的实现类 有对应Http1.1的Http1ExchangeCodec 和 对应Http2.0的Http2ExchangeCodec。其中Http2ExchangeCodec是使用Http2.0中 <strong>数据帧</strong> 的概念完成请求响应的读写。关于Http1ExchangeCodec、Http2ExchangeCodec具体实现原理涉及okio这不再展开。</p> <p>最后一点，CallServerInterceptor的intercept方法中没有调用连接器链Chain的proceed方法，因为这是最后一个拦截器啦！</p> <p>好了，到这里最后一个拦截器也分析完啦！</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本篇分析了ConnectInterceptor、CallServerInterceptor两个拦截器的作用和原理。ConnectInterceptor负责连接的获取，其中涉及到连接池的概念；CallServerInterceptor是真正的网络IO读写。ConnectInterceptor涉及的内容较多，它是Okhttp的核心。  结合上一篇，我们已经分析完了Okhttp内部所有的拦截器，最后给出Okhttp的整体架构图：</p> <p><img src="https://iqqcode-blog.oss-cn-beijing.aliyuncs.com/img-2021-befo/20210612175524.png" alt=""></p> <center>okhttp</center> <p>到这里，Okhttp源码解析部分就真的结束了，可真是一个漫长的过程！ 从使用方式到工作流程，再到具体拦截器，掌握了这四篇文章的内容，应该说得上对Okhttp是比较熟悉了。这里还计划会出第五篇终章，来介绍一些Okhttp的常见问题和高级使用方式，敬请期待！</p> <hr> <p>本文分享自微信公众号 - 胡飞洋（hfydwxgzh），作者：胡飞洋</p> <p>原文出处及转载信息见文内详细说明，如有侵权，请联系 yunjia_community@tencent.com 删除。</p> <p>原始发表时间：2020-06-15</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/iqqcode/icode/edit/master/docs/01.Android/06.网络操作/01.OKHttp/07.拦截器详解2(重点)：连接、请求服务-转载.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=okhttp" title="标签">#okhttp</a><a href="/tags/?tag=net" title="标签">#net</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/06/17, 17:05:09</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/79195c/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">拦截器详解1(重点)：重试、重定向、桥、缓存 转载</div></a> <a href="/pages/b69191/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">补充</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/79195c/" class="prev">拦截器详解1(重点)：重试、重定向、桥、缓存 转载</a></span> <span class="next"><a href="/pages/b69191/">补充</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/e63701/"><div>
            匿名内部类
            <!----></div></a> <span class="date">10-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/2604eb/"><div>
            函数式接口
            <!----></div></a> <span class="date">10-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b378a3/"><div>
            ARouter-Kotlin踩坑
            <!----></div></a> <span class="date">10-05</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:iqqcode@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/IQQcode" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://blog.csdn.net/weixin_43232955" title="CSDN" target="_blank" class="iconfont icon-csdn"></a><a href="https://www.zhihu.com/people/iqqcode" title="知乎" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>iqqcode  |  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a>  |  <a href="http://beian.miit.gov.cn/" target="_blank"> 备案号-京ICP备2021028793号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c4fffd9b.js" defer></script><script src="/assets/js/2.9f83a926.js" defer></script><script src="/assets/js/101.d3a4a836.js" defer></script>
  </body>
</html>
